# åˆ†å¸ƒå¼ç³»ç»Ÿå®è·µå…¥é—¨ï¼šä»¥å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼æœåŠ¡ä¸ºä¾‹

>â€œWhat I cannot create, I do not understand.â€ â€“ Richard Feynman

ğŸš§Noticeï¼šæ–‡æ¡£åŸºæœ¬å®Œæˆï¼Œå„ç§ç»†èŠ‚åœ¨å®Œå–„ä¸­ã€‚

å¦‚æœä½ åšè¿‡ç¨å¾®å¤æ‚ä¸€ç‚¹çš„ç³»ç»Ÿï¼Œæˆ–å¤šæˆ–å°‘éƒ½çŸ¥é“ä¸€äº›å…³äºåˆ†å¸ƒå¼çš„æ¦‚å¿µæˆ–åè¯ï¼Œæ¯”å¦‚ï¼š

- å‰¯æœ¬
- é«˜å¯ç”¨ï¼Œå®¹é”™
- ä¸¤é˜¶æ®µæäº¤ã€ä¸‰é˜¶æ®µæäº¤
- å¹‚ç­‰
- åŒæ­¥ç³»ç»Ÿã€å¼‚æ­¥ç³»ç»Ÿ
- ç½‘è£‚
- CAPç†è®º
- æ‹œå åº­é—®é¢˜
- ååŒæ”»å‡»é—®é¢˜
- FLPç†è®º
- å„ç§ä¸€è‡´æ€§ä¿è¯ï¼šæœ€ç»ˆä¸€è‡´ã€å› æœä¸€è‡´ã€é¡ºåºä¸€è‡´
- å¤åˆ¶çŠ¶æ€æœº
- é€»è¾‘æ—¶é’Ÿ
- åŸå­å¹¿æ’­
- å…±è¯†åŠPaxosã€Raftã€Zabç®—æ³•

å¯¹äºéœ€è¦å·¥ç¨‹å®è·µç»éªŒçš„å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œæœ€é‡è¦çš„é—®é¢˜æ˜¯ï¼š**å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç©¶ç«Ÿæœ‰å“ªäº›æŒ‘æˆ˜å’Œåº”å¯¹æ‰‹æ®µï¼Ÿ**

å‡ºäºè¿™æ ·çš„å¥½å¥‡ï¼Œä½œè€…é€šè¿‡å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼æœåŠ¡ï¼Œå¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç†è®ºè½åœ°ã€å®ç°éš¾ç‚¹æœ‰äº†æ›´æ·±è®¤è¯†ï¼Œ
æœ€åæ€»ç»“å‡ºæ­¤æ–‡ï¼Œè¦†ç›–äº†ç½‘ç»œå®ç°ã€å­˜å‚¨å®ç°ã€paxosç®—æ³•ç†è§£ã€ä¸€è‡´æ€§æ¨¡å‹ã€å‰¯æœ¬å®ç°ç­‰å†…å®¹ã€‚

é¡¹ç›®æºç åŠæ„å»ºã€è¿è¡Œæ–¹å¼è¯·å‚çœ‹ğŸ‘‰ ï¼š[é¡¹ç›®ä¸»é¡µ](https://github.com/z42y/parliament/)ï¼ŒåŒæ—¶æä¾›äº†[javadocå‚è€ƒ](./javadoc/index.html)ã€‚

æ¬¢è¿æissueï¼ğŸš€

## ç³»ç»ŸåŠŸèƒ½

è¯¥æœåŠ¡é™¤äº†å®ç°å¸¸è§çš„"put _key_ _value_"ã€"get _key_"ã€"del _key0_  \[_key1_ ...\]"æ“ä½œï¼Œ
è¿˜å®ç°äº†æŒ‰èŒƒå›´å–å€¼çš„å‘½ä»¤"range _begin_ _end_"ï¼Œå…¶ä¸­beginå’Œendä¸ºå¼€å§‹ã€ç»“æŸkeyå€¼ï¼Œå­—å…¸åºæ’åºã€‚

æœåŠ¡ä½¿ç”¨redisçš„respåè®®è¿›è¡Œé€šä¿¡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨redis-cliç­‰å®¢æˆ·ç«¯è¿æ¥æµ‹è¯•ï¼Œæˆ–è€…ä½¿ç”¨rediså®¢æˆ·ç«¯åº“è¿›è¡Œæ“ä½œã€‚

## æ¥æ”¶è¯·æ±‚
æä¾›æœåŠ¡çš„ç¬¬ä¸€æ­¥æ˜¯æ¥å—ã€è§£æå®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œå‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œä½¿ç”¨JAVA NIOå¤„ç†ã€‚

### JAVA NIOçš„ä½¿ç”¨
é¦–å…ˆæ‰“å¼€socketæ¥æ”¶å®¢æˆ·è¿æ¥ï¼Œåœ¨è¿æ¥æˆåŠŸçš„channelä¸ŠæŒ‚è½½ä¸€ä¸ª[RespReadHandler](./javadoc/io/github/parliament/resp/RespReadHandler.html)ç±»ï¼Œ
ä½¿ç”¨[RespDecoder](./javadoc/io/github/parliament/resp/RespDecoder.html)ç±»å¯¹å¼‚æ­¥åˆ°æ¥çš„å­—èŠ‚æŠ¥æ–‡è¿›è¡Œè§£ç ï¼ŒRespReadHandlerä½¿ç”¨å…¶getæ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è§£ç å®Œæˆã€‚

è§£ç å®Œæˆåï¼Œä½¿ç”¨[KeyValueEngine](./javadoc/io/github/parliament/kv/KeyValueEngine.html)è¿›è¡ŒçœŸæ­£çš„é”®å€¼è¯»å†™å¤„ç†ï¼Œæ­¤å¤„å…ˆä¸è€ƒè™‘KeyvalueEngineçš„å®ç°ç»†èŠ‚ã€‚

æ‰§è¡Œå®Œå®¢æˆ·ç«¯å‘½ä»¤åï¼ŒReadHandleræ–°å»ºä¸€ä¸ª[RespWriteHandler](./javadoc/io/github/parliament/resp/RespWriteHandler.html)å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œ
æ¥ç€é‡æ–°æŒ‚è½½ä¸€ä¸ªRespReadHandlerè¿›è¡Œä¸‹ä¸€ä¸ªè¯·æ±‚å¤„ç†ã€‚

é‡æ–°ç”ŸæˆRespWriterHandlerå’ŒRespReadHandleræ˜¯ä¸ºäº†æ–¹ä¾¿è¿›è¡ŒGCï¼Œå½“ç„¶å¯ä»¥æ‰‹å·¥ç®¡ç†å„ç§bufferçš„å›æ”¶å’Œé‡åˆ©ç”¨ï¼Œè¿™é‡Œä¸åšè¯¦ç»†è®¾è®¡äº†ã€‚

å› ä¸ºä¿å­˜çš„å¯¹è±¡éƒ½æ¯”è¾ƒå°ï¼Œ[KeyValueEngine](./javadoc/io/github/parliament/kv/KeyValueEngine.html)å¹¶æ²¡æœ‰ä½¿ç”¨InputStreamä¹‹ç±»çš„æ¨¡å¼è¿›ä¸€æ­¥æå‡å¼‚æ­¥æ€§èƒ½ã€‚

### ç½‘ç»œåè®®çš„è§£ææ„é€ 
[RespDecoder](./javadoc/io/github/parliament/resp/RespDecoder.html)æ˜¯redisçš„[RESPåè®®](https://redis.io/topics/protocol)è§£ç å™¨ï¼Œ
RESPä¸€å…±æœ‰ä»¥ä¸‹å‡ ç§æ•°æ®ç±»å‹ï¼š
- SIMPLE_STRING å­—ç¬¦ä¸²
- ERROR é”™è¯¯å­—ç¬¦ä¸²
- INTEGER æ•´æ•°
- BULK_STRING äºŒè¿›åˆ¶å­—èŠ‚ç»„
- ARRAY æ•°ç»„

é™¤äº†ARRAYå¯ä»¥åŒ…å«å…¶ä»–ç±»å‹å’Œå…¶ä»–ARRAYï¼Œå¤„ç†ç¨ç¨éº»çƒ¦å¤–ï¼Œå…¶ä»–ç±»å‹éƒ½å®¹æ˜“è§£æã€‚

ä½¿ç”¨JAVAæ ‡å‡†åº“ä¸­ByteBufferç±»ç›´æ¥è§£æåè®®æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œå› ä¸ºæŠ¥æ–‡çš„å†™å…¥å’Œè¯»å–æ˜¯å¹¶å‘çš„ï¼Œä¸å¯èƒ½ç­‰åˆ°æŠ¥æ–‡è¯»å–å®Œæˆåï¼Œæ‰å¼€å§‹è§£æï¼Œ
ç”šè‡³æ— æ³•çŸ¥é“æŠ¥æ–‡ä»€ä¹ˆæ—¶å€™ç»“æŸã€‚

å¦å¤–ï¼ŒæŠ¥æ–‡å¤„ç†å¾€å¾€éœ€è¦"å›æº¯"æ“ä½œï¼Œä»ä¹‹å‰æŸä¸ªä½ç½®é‡æ–°å¼€å§‹è§£æã€‚ä½¿ç”¨ByteBufferçš„flipå’Œrewindã€resetå¤ªåº•å±‚ï¼ŒæŠ½è±¡å±‚æ¬¡ä¸å¤Ÿã€‚

æ‰€ä»¥é€šè¿‡å®ç°è‡ªå·±çš„[ByteBuf](./javadoc/io/github/parliament/resp/ByteBuf.html)è¿›è¡ŒæŠ¥æ–‡è§£æï¼Œä¸»è¦æä¾›äº†ç‹¬ç«‹çš„è¯»å†™indexï¼Œæ–¹ä¾¿å›æº¯å’Œè¯»å†™æ“ä½œåˆ†ç¦»ã€‚
åº•å±‚ä½¿ç”¨byte[]ä¿å­˜æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨direct allocateçš„ByteBufferæå‡æ€§èƒ½ï¼Œä½†æ˜¯ByteBufçš„ç”Ÿå‘½å‘¨æœŸçŸ­ã€æ•°æ®é‡éƒ½å°ï¼Œæ— æ³•ä½“ç°å…¶ä¼˜åŠ¿ã€‚

## é”®å€¼å‘½ä»¤å®ç°
æ”¶åˆ°è¯·æ±‚åï¼Œéœ€è¦æ‰§è¡ŒGETå’ŒPUTã€DELã€RANGEæ“ä½œï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯å…¸å‹çš„æœ‰åºMapæ–¹æ³•ï¼Œæ¯”å¦‚JDKä¸­çš„[NavigableMapæ¥å£](https://docs.oracle.com/javase/9/docs/api/java/util/NavigableMap.html)ï¼Œ
å…¶å¹¶å‘å®ç°[ConcurrentSkipListMap](https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/ConcurrentSkipListMap.html)é‡‡ç”¨äº†skip listç®—æ³•ï¼Œ
æœ¬åº”ç”¨ä¹Ÿé‡‡ç”¨è¯¥ç®—æ³•ã€‚

skip listï¼ˆè·³è¡¨ï¼‰å¹³å‡æŸ¥æ‰¾å’Œæ’å…¥æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(log n)ï¼Œç®—æ³•è¯´æ˜è§[wikipedia](https://zh.wikipedia.org/wiki/%E8%B7%B3%E8%B7%83%E5%88%97%E8%A1%A8)ã€‚
è¯¥ç®—æ³•é€šè¿‡ç»´æŠ¤å¤šå±‚é“¾è¡¨ï¼Œä¾æ¬¡å¿«é€Ÿæ¥è¿‘æŸ¥æ‰¾ç›®æ ‡ã€‚

æ¼”ç¤ºï¼ˆæ¥è‡ªWikipediaï¼‰ï¼š

![skip list](./skiplist.gif)

### skip listçš„æŒä¹…åŒ–å®ç°
åœ¨å†…å­˜ä¸­å®ç°skip listçš„æ•°æ®ç»“æ„éå¸¸ç®€å•ï¼Œä½¿ç”¨æ–‡ä»¶æ¥å£çš„æŒä¹…åŒ–å®ç°åˆ™éœ€è¦è€ƒè™‘å¾ˆå¤šç»†èŠ‚ï¼Œè¿™é‡Œçš„å®ç°ä¸è€ƒè™‘å¹¶å‘ã€‚

é¦–å…ˆéœ€è¦è€ƒè™‘å¦‚ä½•ä½¿ç”¨æ–‡ä»¶è¡¨ç¤ºé“¾è¡¨ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éœ€è¦çŸ¥é“ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä½ç½®ï¼Œ
å¯¹äºå†…å­˜å®ç°çš„skip listï¼Œç¼–ç¨‹è¯­è¨€çš„æŒ‡é’ˆæˆ–å¼•ç”¨å¤„ç†èµ·æ¥éå¸¸è‡ªç„¶ï¼Œä½¿ç”¨æ–‡ä»¶å®ç°ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹å·¥åˆ†é…å’Œç®¡ç†èŠ‚ç‚¹åœ¨æ–‡ä»¶ä¸­çš„åœ°å€å’Œå­˜å‚¨ã€‚

ä»¥skip listçš„æ’å…¥æ“ä½œä¸ºä¾‹ï¼Œä¸€ç§ç®€è¦çš„æ­¥éª¤å¦‚ä¸‹ï¼š
- è·å¾—æœ€ä¸Šå±‚é“¾è¡¨çš„å¤´èŠ‚ç‚¹çš„æ–‡ä»¶åç§°å’Œä½ç½®ä¿¡æ¯ï¼Œæ–‡ä»¶åå’Œä½ç½®ä¿¡æ¯å¯ä»¥è®°å½•åœ¨å…¶ä»–å…ƒä¿¡æ¯æ–‡ä»¶ä¸­ã€‚
- è·å¾—å¤´èŠ‚ç‚¹çš„keyå€¼ï¼Œä¸å‚æ•°keyæ¯”è¾ƒï¼Œä»¥å†³å®šç»§ç»­æŸ¥æ‰¾åŒå±‚ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è¿˜æ˜¯è¿›å…¥ä¸‹ä¸€å±‚é“¾è¡¨ã€‚
    - èŠ‚ç‚¹ä¸­keyçš„é•¿åº¦ä¸æ˜¯å›ºå®šçš„ï¼Œæ–‡ä»¶ä¸­éœ€è¦åŒºåˆ†keyå€¼ã€åœ°å€å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨æŸå›ºå®šå­—æ®µä¿å­˜keyé•¿åº¦ï¼Œä»¥ä¾¿ç¨‹åºå¿«é€Ÿå®šä½ã€‚
- åˆ°è¾¾åº•å±‚èŠ‚ç‚¹åï¼Œå¯»æ‰¾æ’å…¥ä½ç½®ã€‚
    - åº•å±‚èŠ‚ç‚¹éœ€è¦ä¿å­˜keyå¯¹åº”çš„valueå€¼ï¼Œå¯ä»¥ä¿å­˜åœ¨èŠ‚ç‚¹ä¸­ï¼ˆåŒæ ·éœ€è¦ä½¿ç”¨æŸä¸ªå›ºå®šå­—æ®µä¿å­˜valueé•¿åº¦ï¼‰ï¼Œä¹Ÿå¯ä»¥ä¿å­˜åœ¨å…¶ä»–åœ°æ–¹ï¼Œä½¿ç”¨åœ°å€è¿›è¡ŒæŸ¥æ‰¾ï¼Œä½†è¿™æ ·ä¼šå¤šä¸€æ¬¡ç£ç›˜å¯»å€æ“ä½œã€‚
    - å¾…æ’å…¥ä½ç½®å¯èƒ½åœ¨é“¾è¡¨ä¸­é—´ï¼Œæ–‡ä»¶æ¥å£æ²¡æœ‰insertä¹‹ç±»çš„æ“ä½œï¼Œä¸ºäº†åç»­èŠ‚ç‚¹ä¸è¢«è¦†ç›–ï¼Œéœ€ä¾æ¬¡æ‹·è´åç»­èŠ‚ç‚¹åˆ°æ–‡ä»¶ä¸­çš„æ–°ä½ç½®ã€‚
    - æ›´æ”¹èŠ‚ç‚¹ä½ç½®åï¼Œéœ€è¦æ›´æ–°ç›¸å…³èŠ‚ç‚¹ä¿å­˜çš„è¯¥èŠ‚ç‚¹çš„ä½ç½®ä¿¡æ¯ã€‚
    
å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‰ç…§æ–‡ä»¶ç‰©ç†ä½ç½®è¿›è¡Œåœ°å€ç®¡ç†ï¼Œç»´æŠ¤ä½ç½®ä¿¡æ¯éå¸¸éº»çƒ¦ï¼Œæˆ‘ä»¬å¸Œæœ›æ–°èŠ‚ç‚¹çš„åˆ†é…ä¸ä¼šæ”¹å˜åŸæœ‰èŠ‚ç‚¹çš„ç‰©ç†ä½ç½®ï¼Œ
åŒæ—¶å¸Œæœ›å³ä¾¿æ›´æ–°äº†ç›¸å…³èŠ‚ç‚¹çš„ç‰©ç†ä½ç½®åï¼Œä¸ç”¨æ›´æ”¹å…¶ä»–èŠ‚ç‚¹å¯¹è¯¥èŠ‚ç‚¹çš„å¼•ç”¨ã€‚

å‚è€ƒå†…å­˜ç®¡ç†ä¸­ä¸åŒè¿›ç¨‹å…±äº«ç›¸åŒåœ°å€ç©ºé—´çš„æ–¹å¼ï¼Œé‡‡ç”¨ä¸€ä¸ªæ˜ å°„è¡¨ï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªå”¯ä¸€ç¼–å·è¡¨ç¤ºè™šæ‹Ÿåœ°å€ï¼Œåœ¨æ˜ å°„è¡¨ä¸­ä¿å­˜è¯¥è™šæ‹Ÿåœ°å€çš„æ–‡ä»¶ç‰©ç†ä½ç½®ã€‚
è¿™æ ·ï¼Œåœ¨æ–‡ä»¶ä¸­ç§»åŠ¨èŠ‚ç‚¹åï¼Œåªéœ€æ›´æ–°æ˜ å°„è¡¨ä¸­è¯¥èŠ‚ç‚¹çš„æ˜ å°„ä¿¡æ¯ã€‚åˆ†é…æ–°ç©ºé—´æ—¶ï¼Œä¹Ÿä¸ç”¨æŒ‰ç…§é€»è¾‘ä½ç½®å†³å®šç‰©ç†ç©ºé—´çš„ä½ç½®ã€‚

è§£å†³äº†åœ°å€é—®é¢˜ï¼Œè¯¥æ–¹æ¡ˆå¦ä¸€ä¸ªé—®é¢˜æ˜¯æ•ˆç‡ä½ä¸‹ï¼Œæ— è®ºæŸ¥æ‰¾å’Œæ›´æ–°ï¼Œéƒ½éœ€è¦è¯»å–å¾ˆå¤šæ¬¡ç£ç›˜ï¼Œç£ç›˜çš„è¯»å†™æ—¶é—´æ¯”å†…å­˜è¯»å†™æ—¶é—´é«˜ä¸‰ä¸ªæ•°é‡çº§ã€‚

æ¯ä¸ªnodeå¯¹åº”ä¸€ä¸ªåœ°å€ï¼Œç©ºé—´ä¸Šä¸å¤ªç»æµï¼Œ1ä¸‡ä¸ªèŠ‚ç‚¹è‡³å°‘éœ€è¦8ä¸‡ä¸ªå­—èŠ‚çš„æ˜ å°„ç©ºé—´ï¼ˆç¼–å·+åœ°å€ï¼‰ã€‚

å¦å¤–ï¼Œå¤§éƒ¨åˆ†å­˜å‚¨è®¾å¤‡æ˜¯ä»¥"å—"ï¼ˆblockï¼‰ä¸ºè¯»å†™å•ä½çš„ï¼Œå—çš„å¤§å°å¸¸è§æœ‰4K bytesã€8K bytesç­‰ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸€èˆ¬ä»¥è®¾å¤‡çš„å—å¤§å°çš„æ•´æ•°å€ä¸ºè¯»å†™å•ä½ã€‚
å•ä¸ªnodeçš„æ–‡ä»¶è¯»å†™æ— æ³•å‘æŒ¥å—è®¾å¤‡çš„æ€§èƒ½ä¼˜åŠ¿ã€‚

åŒæ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿå¯¹å•ä¸ªæ–‡ä»¶çš„å¤§å°ä¹Ÿæœ‰é™åˆ¶ã€‚

### Pageç®¡ç†
ç»“åˆä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬æŒ‰æ–‡ä»¶ç³»ç»Ÿçš„å—å¤§å°ä¸ºå•ä½åˆ†é…æ–‡ä»¶ç©ºé—´ï¼Œä¸€ä¸ªå—å¤§å°çš„ç©ºé—´ç§°ä¸ºpageï¼Œæ¯ä¸ªpageæœ‰ä¸€ä¸ªå”¯ä¸€ç¼–å·ï¼Œä½¿ç”¨heapï¼ˆå †æ–‡ä»¶ï¼‰ç®¡ç†pageï¼Œheapæ–‡ä»¶å¯èƒ½æœ‰å¤šä¸ªï¼Œ
åœ¨ä¸€ä¸ªpageä¸Šæ‰˜ç®¡å¤šä¸ªå®é™…çš„skip listèŠ‚ç‚¹ã€‚

æ¯ä¸ªheapæ–‡ä»¶çš„ç»“æ„å¦‚ä¸‹ï¼š
```
|------------------heads------------------------|---------pages-------|
| page number (4å­—èŠ‚) | page location (4å­—èŠ‚)|.. | page | page |...|...|
```

#### åˆå§‹åŒ–
ç¬¬ä¸€æ¬¡è¿è¡Œä¼šè¿è¡Œpagerçš„initæ–¹æ³•ï¼Œé€šè¿‡è¯¥æ–¹æ³•æŒ‡å®šheapå­˜å‚¨ç›®å½•ã€æ¯ä¸ªheapæ–‡ä»¶çš„æœ€å¤§å­—èŠ‚æ•°ã€æ¯ä¸ªpageçš„å­—èŠ‚æ•°è¿›è¡Œå­˜å‚¨ç›®å½•çš„åˆå§‹åŒ–ï¼Œ
åœ¨ç›®å½•ä¸­ä½¿ç”¨metainfä¿å­˜å­—èŠ‚æ•°ä¿¡æ¯ï¼Œä½¿ç”¨page_seqæ–‡ä»¶ä¿å­˜å½“å‰æœ€å¤§pageç¼–å·ï¼Œä»¥ä¾¿åœ¨è¿›ç¨‹é‡å¯æ—¶æ¢å¤pageç®¡ç†ã€‚

#### Pageå¯»å€åŠåˆ†é…
Pagerçš„allocateæ–¹æ³•é¦–å…ˆä½¿ç”¨ç©ºé—²pageçš„ç¼–å·ï¼ˆä»metainfå°¾éƒ¨è·å–ç©ºé—²pageç¼–å·ï¼‰ï¼Œæ²¡æœ‰ç©ºé—²pageåˆ™é€’å¢page_seqï¼Œè·å¾—ä¸€ä¸ªæ–°çš„pageç¼–å·ï¼Œ
é€šè¿‡pageç¼–å·æŸ¥æ‰¾åˆ°å¯¹åº”çš„heapæ–‡ä»¶ï¼Œå¦‚æœheapæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–ï¼Œä»heapæ–‡ä»¶æ„é€ ä¸€ä¸ªHeapå¯¹è±¡ã€‚

Heapå¯¹è±¡çš„å¤´éƒ¨headsæˆå‘˜å°†pageç¼–å·æ˜ å°„ä¸ºpageåœ¨è¯¥heapæ–‡ä»¶çš„åç§»åœ°å€ï¼Œå¦‚pageæœªåˆ†é…ï¼Œåˆ™åç§»ä¸º-1ã€‚

æ–°å»ºpageä»heapå°¾éƒ¨åˆ†é…ï¼Œåˆ†é…åæ›´æ–°headä¿¡æ¯å¹¶æŒä¹…åŒ–åˆ°heapæ–‡ä»¶ã€‚

### SkipListçš„æŸ¥æ‰¾
ä¸€ä¸ªpageä¸­åŒ…å«å¤šä¸ªskip listèŠ‚ç‚¹ï¼Œä¸ºäº†æé«˜è¯»å†™é€Ÿåº¦ï¼Œä¸€èˆ¬å°†pageç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œæ›´æ–°åï¼Œå†™å›æ–‡ä»¶ï¼Œè¿™é‡Œä½¿ç”¨weak referenceçš„cacheç¼“å­˜pageã€‚

skiplist.mfä¿å­˜äº†æ¯å±‚é¦–èŠ‚ç‚¹çš„ç¼–å·ï¼Œç”±SkipList.initæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚

pageè¢«åŠ è½½åˆ°å†…å­˜åï¼Œå„ä¸ªèŠ‚ç‚¹è½¬æ¢ä¸ºJDK NavigableMapåŒ…å«çš„æ¡ç›®ï¼Œä»¥ä¾¿pageä¸­å¿«é€ŸæŸ¥æ‰¾å®šä½ã€‚
skip listçš„ä¸Šå±‚èŠ‚ç‚¹å’Œåº•å±‚èŠ‚ç‚¹çš„å€¼å«ä¹‰ä¸åŒï¼Œä¸Šå±‚èŠ‚ç‚¹çš„valueè¡¨ç¤ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ‰€åœ¨pageçš„ç¼–å·ï¼Œåº•å±‚èŠ‚ç‚¹çš„valueè¡¨ç¤ºçœŸæ­£ä¿å­˜çš„å€¼ã€‚

ä¸ç®¡æŸ¥è¯¢è¿˜æ˜¯å†™å…¥ã€åˆ é™¤ï¼Œéƒ½éœ€è¦å…ˆå®šä½èŠ‚ç‚¹æ‰€åœ¨pageé¡µé¢ï¼Œå¦‚æŸ¥æ‰¾æŸkeyåœ¨æŸå±‚çº§çš„pageï¼Œä»£ç å¦‚ä¸‹ï¼š
```{.java}
private SkipListPage findSkipListPageForKey(byte[] key, int lv) throws IOException, ExecutionException {
    Preconditions.checkArgument(lv >= 0);
    Preconditions.checkArgument(lv < SkipList.this.height);
    int cursor = height - 1;
    SkipListPage start = null;
    SkipListPage up = null;
    while (cursor >= lv) {
        up = start;
        if (start == null) {
            start = skipListPages.get(startPages[cursor]);
        }
        SkipListPage slice = floorPage(start, key);

        if (cursor == lv) {
            return slice == null ? start : slice;
        }
        if (slice != null) {
            Map.Entry<byte[], byte[]> e = slice.map.floorEntry(key);
            int pn = ByteBuffer.wrap(e.getValue()).getInt();
            start = skipListPages.get(pn);
            start.setSuperPage(up);
        } else {
            start = null;
        }

        cursor--;
    }

    return start;
}
```
è¿™ä¸ªæ–¹æ³•è¿˜è´Ÿè´£æ›´æ–°ç›¸å…³pageçš„ä¸Šä¸€å±‚pageä¿¡æ¯ã€‚

floorPageä»æŒ‡å®špageå¼€å§‹æŸ¥æ‰¾æ‹¥æœ‰æœ€åä¸€ä¸ªå°äºç­‰äºå¾…æŸ¥æ‰¾å€¼çš„keyæ‰€åœ¨çš„pageï¼Œå®ç°å¦‚ä¸‹ï¼š
```{.java}
private SkipListPage floorPage(SkipListPage start, byte[] key) throws ExecutionException {
    SkipListPage current = start;
    SkipListPage floor = null;
    while (current != null) {
        Map.Entry<byte[], byte[]> entry = current.map.floorEntry(key);
        if (entry != null) {
            // åªæ˜¯åœ¨æœ¬pageå‘ç°å°äºkeyçš„è®°å½•ï¼Œè¿˜éœ€æ£€æŸ¥ä¸‹ä¸€é¡µã€‚
            floor = current;
        }

        if (current.getRightPageNo() > 0) {
            int pn = current.getRightPageNo();
            current = skipListPages.get(pn);
        } else {
            current = null;
        }
    }
    return floor;
}
```
æ³¨æ„ï¼Œå¦‚æœåœ¨è¯¥pageå¯¹åº”mapæœªæ‰¾åˆ°å¤§äºæŸ¥æ‰¾å€¼çš„è®°å½•ï¼Œè¿˜éœ€è¦åˆ°ä¸‹ä¸€ä¸ªpageæŸ¥æ‰¾ã€‚

### SkipListçš„æ›´æ–°
æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹å‰ï¼Œå…ˆä½¿ç”¨ä»¥ä¸Šæ–¹æ³•æŸ¥æ‰¾ã€åŠ è½½å¾…æ’å…¥çš„pageï¼Œæ›´æ–°ç›¸å…³mapï¼Œå†ä½¿ç”¨SkipListPage.updateæ›´æ–°æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š
```{.java}
private void update() throws IOException, ExecutionException {
    int s = HEAD_SIZE_IN_PAGE;
    int k = 0;

    for (byte[] key : map.keySet()) {
        s += key.length;
        s += 4;
        s += map.get(key).length;
        if (isLeaf) {
            s += 4;
        }
        k++;
    }
    size = s;
    keys = k;
    if (keys == 0) {
        pager.recycle(page);
    }

    if (remaining() < 0) {
        split();
    } else {
        sync();
    }
}
```

å¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœpageä¸åœ¨åŒ…å«æ•°æ®ï¼Œåˆ™å›æ”¶ï¼Œå¦‚æ•°æ®å·²è¶…è¿‡pageå¤§å°ï¼Œåˆ™åˆ†è£‚pageï¼Œåˆ†è£‚æ–¹æ³•ä¸ºåˆ†é…ä¸€ä¸ªpageï¼Œå¹¶å°†é™¤å¤´èŠ‚ç‚¹ä»¥å¤–çš„èŠ‚ç‚¹å­˜å‚¨åˆ°æ–°pageå³å¯ã€‚
```{.java}
private void split() throws IOException, ExecutionException {
    Preconditions.checkState(this.keys > 0);
    Preconditions.checkState(!map.isEmpty());
    Page p = SkipList.this.allocatePage(level);
    SkipListPage newPage = skipListPages.get(p.getNo());

    newPage.map = new ConcurrentSkipListMap<>(map.tailMap(map.firstKey(), false));
    Preconditions.checkState(!map.isEmpty());
    map = new ConcurrentSkipListMap<>(map.headMap(map.firstKey(), true));
    newPage.rightPageNo = this.rightPageNo;
    this.rightPageNo = newPage.getPage().getNo();

    this.update();
    newPage.update();

    Preconditions.checkState(pager.getPageSize() - this.getSize() >= 0);
    Preconditions.checkState(pager.getPageSize() - newPage.getSize() >= 0);
}
```

æ³¨æ„ï¼Œæ–‡ä»¶å†™å…¥ä¸æ˜¯åŸå­çš„ï¼Œå¯èƒ½åªå†™å…¥äº†éƒ¨åˆ†æ•°æ®ä¾¿å®•æœºäº†ï¼Œä¸å®Œæ•´çš„æ•°æ®ä¼šå¯¼è‡´è¿›ç¨‹æ— æ³•æ¢å¤åŸæœ‰çŠ¶æ€ï¼Œ
ï¼Œpersistence()éœ€è¦ä¿è¯è¦ä¹ˆå®Œå…¨å†™å…¥ï¼Œè¦ä¹ˆå®Œå…¨ä¸å†™ï¼Œ

AtomicFileWriterç±»å®ç°äº†åŸå­å†™å…¥ï¼Œå¹¶åœ¨è¿›ç¨‹å¯åŠ¨æ—¶è¿›è¡Œæ£€æŸ¥å’Œæ¢å¤ã€‚

## å®¹é”™ä¸é«˜å¯ç”¨
### ä¸»ä»åŒæ­¥
å•ä¸ªè¿›ç¨‹çš„å®¹é”™èƒ½åŠ›ååˆ†æœ‰é™ï¼Œä¸ºäº†åœ¨å‘ç”Ÿç¡¬ä»¶æ•…éšœã€æ–­ç”µã€ç½‘ç»œæ•…éšœã€è¿ç»´æ•…éšœçš„æƒ…å†µä¸‹ä¾ç„¶å¯æä¾›æœåŠ¡ï¼Œ
ç³»ç»Ÿéœ€è¦è¿›è¡Œå®¹é”™è®¾è®¡ã€‚

å¯¹äºç½‘ç»œæœåŠ¡ï¼Œæœ€ç®€å•çš„å®¹é”™æ–¹å¼å°±æ˜¯ä¸»ä»å¤åˆ¶ï¼Œä»æœåŠ¡è¿›ç¨‹ä¸æ–­å¤åˆ¶ä¸»è¿›ç¨‹æ•°æ®ï¼Œå½“ä¸»è¿›ç¨‹å®•æœºåï¼Œåˆ‡æ¢åˆ°ä»è¿›ç¨‹ç»§ç»­ä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚
å¯¹äºä¸Šé¢skip listå®ç°ï¼Œè·Ÿéšè€…ä¾æ¬¡æ‹·è´ä¸»è¿›ç¨‹å‘½ä»¤åˆ°æœ¬åœ°æ‰§è¡Œå³å¯ã€‚

### æ­£ç¡®æ€§ä¸ä¸€è‡´æ€§æ¨¡å‹
ä¸Šé¢è¿™ç§ç®€å•çš„ä¸»ä»åŒæ­¥æ–¹æ³•å¯ä»¥ä¿è¯ç³»ç»Ÿé«˜å¯ç”¨ï¼Œä½†æ˜¯é™¤äº†é«˜å¯ç”¨ï¼Œè¿˜è¦æ»¡è¶³æ­£ç¡®ç‡ã€å®¹é‡ã€å»¶è¿Ÿç­‰è¦æ±‚ã€‚
å¯¹äºé”®å€¼æœåŠ¡ï¼Œæ­£ç¡®ç‡æ˜¯æŒ‡å®¢æˆ·èƒ½å¤Ÿå®¹å¿å¤šå°‘æ•°æ®ä¸¢å¤±æˆ–æ•°æ®ä¸æ­£ç¡®ï¼Œä¸åŒåº”ç”¨å¯¹æ­£ç¡®æ•°æ®çš„å®šä¹‰å„ä¸ç›¸åŒã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè¯¥é”®å€¼æœåŠ¡ç”¨äºä¿å­˜æ–‡ç« è¯„è®ºï¼š

1. å¯¹äºç½‘ç«™Aï¼Œè¦æ±‚ç”¨æˆ·èƒ½ç«‹åˆ»çœ‹åˆ°è‡ªå·±å‘è¡¨çš„è¯„è®ºï¼Œå…¶ä»–ç”¨æˆ·å¯èƒ½åœ¨ä¸€æ®µæ—¶é—´åæ‰èƒ½çœ‹åˆ°è¯¥ç”¨æˆ·çš„è¯„è®ºã€‚
2. å¯¹äºç½‘ç«™Bï¼Œè¦æ±‚ç”¨æˆ·å‘è¡¨çš„è¯„è®ºå¿…é¡»å’Œä»–å‘è¡¨è¯„è®ºä¹‹å‰èƒ½çœ‹åˆ°çš„å…¶ä»–è¯„è®ºä¸€èµ·è¢«å…¶ä»–ç”¨æˆ·çœ‹åˆ°ã€‚
3. å¯¹äºç½‘ç«™Cï¼Œè¦æ±‚ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œæ‰€æœ‰ç”¨æˆ·çœ‹åˆ°çš„è¯„è®ºå’Œè¯„è®ºé¡ºåºéƒ½ç›¸åŒã€‚
4. å¯¹äºç½‘ç«™Dï¼Œè¦æ±‚ç›¸åŒç”¨æˆ·å‘è¡¨çš„å¤šä¸ªè¯„è®ºï¼Œå…¶é¡ºåºå’Œå…¶å‘è¡¨é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚
5. å¯¹äºç½‘ç«™Eï¼Œè¦æ±‚ä»»ä½•è¯„è®ºä¸€ç»å‘è¡¨ï¼Œç«‹åˆ»èƒ½è¢«æ‰€æœ‰ç”¨æˆ·çœ‹åˆ°ï¼Œè€Œä¸”æ‰€æœ‰è¯„è®ºçš„æ’åˆ—é¡ºåºä¸€å®šç›¸åŒã€‚

è¿™äº›æ­£ç¡®æ€§è¦æ±‚éƒ½å¯ä»¥ç”¨[ä¸€è‡´æ€§æ¨¡å‹](https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B)è¡¨ç¤ºï¼Œ
ä»¥ä¸Šæƒ…å†µåˆ†åˆ«å¯¹åº”äº†ï¼š

1. Read-your-own-writesä¸€è‡´æ€§ã€‚
2. å› æœä¸€è‡´æ€§ï¼šä¸¾ä¸ªä¾‹å­ï¼Œç”¨æˆ·å‘è¡¨çš„è¯„è®ºå¯èƒ½é€šè¿‡å¤åˆ¶ç²˜è´´å¼•ç”¨äº†ä»–å½“æ—¶çœ‹åˆ°çš„å…¶ä»–è¯„è®ºå†…å®¹ï¼Œé‚£ä¹ˆå½“ä»–çš„è¯„è®ºå‘è¡¨åï¼Œè¿™äº›è¯„è®ºä¹Ÿåº”è¯¥èƒ½è¢«æ‰€æœ‰ç”¨æˆ·éƒ½çœ‹åˆ°ã€‚
å› ä¸ºä¹‹å‰çš„è¯„è®ºå’Œè¿™æ¬¡å‘è¡¨çš„è¯„è®ºæœ‰å› æœå…³ç³»ï¼Œå¦åˆ™å¯¹æŸäº›è¯„è®ºï¼Œç”¨æˆ·å¯èƒ½æ— æ³•è·å¾—æ­£ç¡®çš„ä¸Šä¸‹æ–‡ã€‚
3. æœ€ç»ˆä¸€è‡´æ€§ã€‚
4. å•è°ƒå†™ä¸€è‡´ï¼šä¸åŒç”¨æˆ·çš„è¯„è®ºåˆ—è¡¨å¯èƒ½ä¸åŒï¼Œä½†æ˜¯å¯¹äºæŸä¸ªç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰è¯„è®ºï¼Œå…¶é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚
å¦‚aç”¨æˆ·å…ˆåæœ‰è¯„è®ºï¼ša1å’Œa2ï¼Œbç”¨æˆ·å…ˆåæœ‰è¯„è®ºï¼šb1å’Œb2ï¼Œé‚£ä¹ˆa1,b1,b2,a2æ»¡è¶³å•è°ƒå†™ä¸€è‡´ï¼Œä½†æ˜¯b2,a1,a2,b1ä¸æ»¡è¶³ã€‚
5. é¡ºåºä¸€è‡´æ€§ï¼šæ‰€æœ‰ç”¨æˆ·çœ‹åˆ°çš„è¯„è®ºå†…å®¹å’Œé¡ºåºéƒ½ä¸€æ ·ã€‚

ä»¥ä¸Šä¸€è‡´æ€§éƒ½æ˜¯ä»¥ç”¨æˆ·ï¼ˆå‡†ç¡®è¯´æ˜¯ç”¨æˆ·æµè§ˆå™¨è¿›ç¨‹ï¼‰è§’åº¦å‡ºå‘çš„ï¼Œä¸€è‡´æ€§æ¨¡å‹æ²¡æœ‰å¥½åä¹‹åˆ†ï¼Œ
ä¸€è‡´æ€§è¦æ±‚è¶Šé«˜ï¼Œå®ç°éš¾åº¦è¶Šå¤§ï¼Œç³»ç»Ÿå»¶è¿Ÿä¹Ÿè¶Šå¤§ï¼Œä½†æ˜¯å¯¹ä½¿ç”¨è€…æ›´å‹å¥½ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚

å¯¹äºä¸Šé¢çš„ä¸»ä»æ¶æ„ï¼Œåªèƒ½åœ¨ç³»ç»Ÿæ¢å¤åï¼Œå®ç°æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸»ä»åˆ‡æ¢å’Œç½‘è£‚å¾ˆå®¹æ˜“è¿èƒŒå…¶ä»–ä¸€è‡´æ€§æ¨¡å‹ã€‚

æˆ‘ä»¬é€‰æ‹©å¯¹ä½¿ç”¨è€…æœ€ç®€å•çš„é¡ºåºä¸€è‡´æ€§ä½œä¸ºå®ç°ç›®æ ‡ã€‚

å…¶ä»–é”®å€¼æœåŠ¡ï¼Œå¦‚äºšé©¬é€Šçš„DynamoDBï¼Œé‡‡ç”¨å¤šå†™+å¤šè¯»ï¼ˆå†™èŠ‚ç‚¹+è¯»èŠ‚ç‚¹>èŠ‚ç‚¹æ€»æ•°ï¼‰çš„æ–¹å¼é™ä½æ•°æ®ä¸ä¸€è‡´çš„æœºç‡ï¼Œ
å¹¶é‡‡ç”¨[é€»è¾‘æ—¶é’Ÿ](https://en.wikipedia.org/wiki/Logical_clock)è§£å†³å†²çªï¼Œä¿è¯æœ€ç»ˆè¯»ä¸€è‡´ï¼Œç»†èŠ‚å¯å‚è€ƒå…¶è®ºæ–‡ã€‚

## ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ä¿è¯é¡ºåºä¸€è‡´æ€§
é¡ºåºä¸€è‡´æ€§ä¹‹æ‰€ä»¥ç®€å•ï¼Œæ˜¯å› ä¸ºæ— è®ºç³»ç»Ÿæœ‰å¤šå°‘å°æœºå™¨ï¼Œå¯¹äºä½¿ç”¨è€…æ¥è¯´ï¼Œå’Œä½¿ç”¨ä¸€å°æœºå™¨æ²¡æœ‰åŒºåˆ«ã€‚

å¦‚æœèƒ½å¤Ÿä¿è¯ä¸»ä»æœºå™¨ä»»ä½•æ—¶å€™æ•°æ®éƒ½æ˜¯ç›¸åŒçš„ï¼Œåˆ™å¯ä»¥ä¿è¯é¡ºåºä¸€è‡´æ€§ã€‚
è¿™æ„å‘³ç€å¯¹æ‰€æœ‰æœºå™¨æ¥è¯´ï¼Œæ•°æ®æ›´æ”¹æ˜¯åŸå­çš„ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆæ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Œè¿™æ˜¯äº‹åŠ¡çš„æ¦‚å¿µã€‚

ä»¥å¸¸è§çš„[ä¸¤é˜¶æ®µæäº¤ç®—æ³•](https://zh.wikipedia.org/zh-hans/%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4)å®ç°ä¸ºä¾‹ï¼Œ
ä¸»è¿›ç¨‹æ”¶åˆ°è¯·æ±‚åï¼Œå…ˆå‘ä»è¿›ç¨‹å‘èµ·æäº¤ï¼Œå¦‚æ‰€æœ‰ä»è¿›ç¨‹åŒæ„æäº¤ï¼Œ
åˆ™ä¸»è¿›ç¨‹é€šçŸ¥æ‰€æœ‰è¿›ç¨‹æ‰§è¡Œè¯¥è¯·æ±‚ï¼Œå¦åˆ™ä¸»è¿›ç¨‹é€šçŸ¥å…¶ä»–è¿›ç¨‹å–æ¶ˆè¯¥è¯·æ±‚ã€‚

### åˆ†å¸ƒå¼äº‹åŠ¡çš„å±€é™
ä¸¤é˜¶æ®µæäº¤æœ€å¤§çš„é—®é¢˜æ˜¯å­˜åœ¨å•ç‚¹æ•…éšœï¼š

- ä¸»è¿›ç¨‹å®•æœºï¼Œæ— æ³•å“åº”ä»»ä½•è¯·æ±‚ã€‚
- åœ¨å‘èµ·é˜¶æ®µï¼Œä»»ä½•ä»è¿›ç¨‹å®•æœºæˆ–å› ç½‘ç»œæ•…éšœæ— æ³•é€šä¿¡ï¼Œéƒ½ä¼šå¯¼è‡´ç³»ç»Ÿæ— æ³•å“åº”ä»»ä½•è¯·æ±‚ã€‚

ä¸‰é˜¶æ®µæäº¤å¯ä»¥è§£å†³ç¬¬äºŒç§æ•…éšœï¼Œä½†æ˜¯å‡ºç°ç½‘ç»œåˆ†è£‚æ—¶ï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™é‡Œä¸åšç»†è®²ã€‚

å­˜åœ¨å•ç‚¹æ•…éšœæ„å‘³ç€ä¸èƒ½æ»¡è¶³æˆ‘ä»¬é«˜å¯ç”¨çš„ç›®æ ‡ã€‚

### åˆ†å¸ƒå¼äº‹åŠ¡å’Œåˆ†å¸ƒå¼ä¸€è‡´æ€§æ¨¡å‹çš„å…³ç³»
åˆ†å¸ƒå¼äº‹åŠ¡ä¸ºäº†ä¿è¯å„ä¸ªå‚ä¸è€…çš„ä»»åŠ¡è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å–æ¶ˆï¼Œè€Œä¸æ˜¯ä¸ºäº†ä¿è¯é«˜å¯ç”¨ã€‚
åˆ†å¸ƒå¼äº‹åŠ¡å¯ä»¥ä½œä¸ºå®ç°ä¸€è‡´æ€§æ¨¡å‹çš„æŠ€æœ¯æ‰‹æ®µã€‚

æ­¤å¤–ï¼Œåœ¨æ•°æ®åº“ä¸­å¸¸æåˆ°çš„ACIDçš„ä¸€è‡´æ€§ï¼Œå’Œåˆ†å¸ƒå¼ä¸€è‡´æ€§ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œå‚è€ƒ[foundationdbæ–‡æ¡£çš„è§£é‡Š](https://apple.github.io/foundationdb/consistency.html)
>The â€œCâ€ in ACID refers to the property that data remains within an applicationâ€™s integrity constraints. (For example, the constraint that some data and its index are consistent with respect to each other.)
>The â€œCâ€ in CAP relates to a consistency model, which describes the conditions under which write operations from one client become visible to other clients. (One example is the eventual consistency model, in which writes are expected to be consistent across replicas after a sufficiently long period.)

## å¤åˆ¶çŠ¶æ€æœº
å¦‚æœå°†è¿›ç¨‹çœ‹åšä¸€ä¸ªçŠ¶æ€æœºï¼Œé‚£ä¹ˆå¦‚æœæ‰€æœ‰è¾“å…¥éƒ½ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªçŠ¶æ€æœºçš„çŠ¶æ€ä¸€å®šèƒ½è¾¾åˆ°ä¸€è‡´ï¼Œè¿™å°±æ˜¯å¤åˆ¶çŠ¶æ€æœºçš„æ€æƒ³ã€‚

### å…¨åºå¹¿æ’­ï¼ˆåŸå­å¹¿æ’­ï¼‰
å¯¹äºé”®å€¼ç³»ç»Ÿï¼Œè¾“å…¥å°±æ˜¯å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç³»ç»Ÿå¦‚æœèƒ½å°†æ¥è‡ªä»»æ„å®¢æˆ·ç«¯çš„è¯·æ±‚è¿›è¡Œæ’åºï¼Œå¹¶ç»Ÿä¸€æŒ‰è¯¥é¡ºåºåœ¨å„ä¸ªè¿›ç¨‹æ‰§è¡Œï¼Œåˆ™ä¸€å®šæ»¡è¶³é¡ºåºä¸€è‡´æ€§ã€‚

è¿™ç§åšæ³•ç§°ä¸ºå…¨åºå¹¿æ’­æˆ–åŸå­å¹¿æ’­ã€‚

### å…±è¯†
ä¸€ç§ç›´è§‚ä½†é”™è¯¯çš„æ’åºåšæ³•æ˜¯ä½¿è¯·æ±‚å¸¦ä¸Šæ—¶é—´æˆ³ï¼ŒæœåŠ¡ç«¯ä½¿ç”¨æ—¶é—´æˆ³æ’åºã€‚

ä½†å¤šä¸ªå®¢æˆ·ç«¯ä¼šå‘ç”Ÿå¹¶å‘æ“ä½œï¼ŒæœåŠ¡å™¨æ— æ³•åŒºåˆ†è¿™äº›æ“ä½œçš„å…ˆåé¡ºåºï¼Œå› ä¸ºç¡¬ä»¶æ—¶é’Ÿå¹¶ä¸å¯é ï¼Œå³ä¾¿å­˜åœ¨ä¸€ä¸ªå¯é çš„æ—¶é’Ÿï¼Œç½‘ç»œçš„å»¶è¿Ÿä¹Ÿå¯¼è‡´æ“ä½œåœ¨ä¸åŒèŠ‚ç‚¹æœ‰ä¸åŒçš„åˆ°è¾¾é¡ºåºã€‚
èŠ‚ç‚¹åœ¨æ”¶åˆ°ä¸€ä¸ªæ“ä½œè¯·æ±‚æ—¶ï¼Œå¦‚ä½•ç¡®å®šæ˜¯å¦æœ‰ä¹‹å‰çš„æ“ä½œå°šæœªåˆ°è¾¾ï¼Ÿè¿™æ˜¯æ— æ³•åšåˆ°çš„ã€‚

æ¢ä¸ªæ€è·¯ï¼Œå¦‚æœå¯¹æ¯ä¸ªè¯·æ±‚åˆ†é…ä¸€ä¸ªå…¨å±€é€’å¢çš„ç¼–å·ï¼ŒåŒæ—¶æ‰€æœ‰è¿›ç¨‹å¯¹åœ¨æ¯ä¸ªç¼–å·çš„è¯·æ±‚å†…å®¹ä½œè¾¾æˆä¸€è‡´ï¼Œæ‰€æœ‰è¿›ç¨‹æŒ‰ç¼–å·ä¾æ¬¡æ‰§è¡Œè¯·æ±‚ï¼Œåˆ™çŠ¶æ€ä¸€å®šèƒ½è¾¾åˆ°ä¸€è‡´ã€‚
è¿™æ„å‘³ç€å…·æœ‰ç›¸åŒç¼–å·çš„å¤šä¸ªè¯·æ±‚åªæœ‰ä¸€ä¸ªä¼šè¢«é€‰ä¸­æ‰§è¡Œï¼Œè¯·æ±‚æœªè¢«é€‰ä¸­çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥é€‰æ‹©é‡è¯•ã€‚

è¿™å°±æŠŠé—®é¢˜å˜æˆäº†ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼å…±è¯†é—®é¢˜ï¼š
>å¼‚æ­¥ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªè¿›ç¨‹å¯¹æŸä¸€ä¸ªææ¡ˆçš„å†…å®¹è¾¾æˆä¸€è‡´çš„è¿‡ç¨‹ï¼Œå°±æ˜¯å…±è¯†ã€‚

åå•†**æ¯ä¸ª**ç¼–å·æ“ä½œå†…å®¹çš„è¿‡ç¨‹ï¼Œå°±æ˜¯**ä¸€æ¬¡**åˆ†å¸ƒå¼å…±è¯†è¾¾æˆè¿‡ç¨‹ï¼Œå› æ­¤å…¨åºå¹¿æ’­é—®é¢˜ç­‰ä»·ä¸ºå…±è¯†é—®é¢˜ã€‚

## ç†è§£Paxoså…±è¯†ç®—æ³•
å¸¸è§çš„å…±è¯†ç®—æ³•æœ‰Paxoså’Œraftï¼Œæˆ‘ä»¬ä½¿ç”¨Paxoså…±è¯†ç®—æ³•ã€‚

Paxosç®—æ³•çš„æ¨å¯¼è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªä¸ºäº†å¾—åˆ°ç»“æœï¼Œä¸æ–­å¯¹æ¡ä»¶è¿›è¡Œçº¦æŸçš„è¿‡ç¨‹ã€‚

é¦–å…ˆï¼ŒæŸä¸ªèŠ‚ç‚¹ä½œä¸ºå‘èµ·è€…ï¼ˆproposerï¼‰ï¼Œå¯¹å…¶ä»–èŠ‚ç‚¹å‘èµ·ææ¡ˆï¼Œæ¥æ”¶è€…éœ€è¦æ»¡è¶³**çº¦æŸP1**ï¼š

> P1ï¼šä¸€ä¸ª acceptor å¿…é¡»æ¥å—ï¼ˆacceptï¼‰ç¬¬ä¸€æ¬¡æ”¶åˆ°çš„ææ¡ˆã€‚
    
æ˜¾ç„¶ï¼Œè¿åP1çš„ç³»ç»Ÿï¼Œä¸ä¼šé€šè¿‡ä»»ä½•ææ¡ˆè¢«é€šè¿‡ã€‚

ä½†å¦‚æœç½‘ç»œåˆ†è£‚ä¸ºAå’ŒBä¸¤ä¸ªç½‘ç»œï¼ŒAå’ŒBä¸èƒ½äº’é€šï¼Œä¸€ä¸ªææ¡ˆåœ¨Aå¾—åˆ°æ‰¹å‡†ï¼Œå¦ä¸€ä¸ªææ¡ˆåœ¨Bç½‘ç»œå¾—åˆ°æ‰¹å‡†ï¼Œåˆ™ä¼šå‡ºç°ææ¡ˆä¸ä¸€è‡´çš„æƒ…å†µã€‚
è§£å†³æ–¹æ¡ˆæ˜¯åªæ‰¹å‡†è·å¾—è¶…è¿‡ä¸€åŠï¼ˆå¤§å¤šæ•°ï¼‰æ¥æ”¶è€…åŒæ„çš„ææ¡ˆã€‚

ä½†æ˜¯Aå’ŒBç½‘ç»œå¯èƒ½æœ‰é‡å ï¼Œæ­¤æ—¶æŸäº›èŠ‚ç‚¹å¯èƒ½ä¼šæ”¶åˆ°ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ææ¡ˆï¼Œè¿™äº›èŠ‚ç‚¹å¿…é¡»èƒ½å¤Ÿæ¥å—è¿™äº›ä¸¤ä¸ªåŠä»¥ä¸Šçš„ææ¡ˆï¼Œå› ä¸ºæŒ‰ç…§çº¦æŸP1ï¼Œ
è¿™äº›ææ¡ˆå¯èƒ½æ˜¯å…¶ä»–èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªææ¡ˆï¼Œå·²ç»è¢«æ¥å—äº†ã€‚

ä¸ºäº†åŒºåˆ†ææ¡ˆï¼Œéœ€è¦ä¸ºææ¡ˆåˆ†é…ç¼–å·ï¼Œæ¯”å¦‚å‘èµ·èŠ‚ç‚¹çš„æœ¬åœ°åºåˆ—å·+ipåœ°å€ã€‚è¿™é‡Œä¸è¦æ··æ·†ææ¡ˆçš„ç¼–å·å’Œå¤åˆ¶çŠ¶æ€æœºè¾“å…¥çš„ç¼–å·ï¼Œ
çŠ¶æ€æœºæ¯ä¸ªç¼–å·ï¼ˆä¾æ¬¡é€’å¢ï¼‰çš„è¾“å…¥å†…å®¹å¯¹åº”ä¸€æ¬¡å…±è¯†è¿‡ç¨‹ï¼Œè¯¥å…±è¯†è¿‡ç¨‹å¯èƒ½å­˜åœ¨å¤šä¸ªç¼–å·ï¼ˆåªéœ€ä¿è¯å•è°ƒï¼‰çš„ææ¡ˆã€‚

æ—¢ç„¶æ¥æ”¶è€…éœ€æ¥æ”¶å¤šä¸ªææ¡ˆï¼Œè¿™å°±å¼•å‡º**çº¦æŸP2**ï¼š

>P2ï¼šä¸€æ—¦ä¸€ä¸ªå…·æœ‰ value v çš„ææ¡ˆè¢«æ‰¹å‡†ï¼ˆchosenï¼‰ï¼Œé‚£ä¹ˆè¢«æ‰¹å‡†ï¼ˆchosenï¼‰çš„æ›´é«˜ç¼–å·çš„ææ¡ˆå¿…é¡»å…·æœ‰ value vã€‚

ææ¡ˆè¢«æ‰¹å‡†ï¼Œè¡¨ç¤ºè‡³å°‘è¢«ä¸€ä¸ªæ¥æ”¶è€…æ¥å—è¿‡ã€‚æ‰€ä»¥åŠ å¼ºP2ï¼Œå¾—åˆ°çº¦æŸP2aï¼š

>ä¸€æ—¦æŸä¸ªææ¡ˆå€¼vè·å¾—æ‰¹å‡†ï¼Œä»»ä½•æ¥æ”¶è€…æ¥æ”¶çš„æ›´é«˜ç¼–å·çš„ææ¡ˆå€¼ä¹Ÿæ˜¯vã€‚
    
å› ä¸ºé€šä¿¡æ˜¯å¼‚æ­¥çš„ï¼Œä¸€ä¸ªä»ä¼‘çœ æˆ–æ•…éšœæ¢å¤çš„èŠ‚ç‚¹ï¼Œç»™æŸä¸ªå°šæœªæ”¶åˆ°ä»»ä½•ææ¡ˆçš„èŠ‚ç‚¹ï¼Œæäº¤ä¸€ä¸ªæ›´é«˜ç¼–å·çš„ä¸åŒææ¡ˆv1ï¼ŒæŒ‰ç…§çº¦æŸP1ï¼Œè¯¥èŠ‚ç‚¹å¿…é¡»æ¥æ”¶è¯¥ææ¡ˆï¼Œ
è¿™å°±è¿èƒŒäº†çº¦æŸP2aï¼Œæ‰€ä»¥ï¼Œä¸å…¶çº¦æŸæ¥æ”¶è€…ï¼Œçº¦æŸæäº¤è€…æ›´åŠ æ–¹ä¾¿ï¼Œå¯¹P2aåŠ å¼ºçº¦æŸï¼Œå¾—åˆ°çº¦æŸP2bï¼š

>ä¸€æ—¦æŸä¸ªææ¡ˆå€¼vè·å¾—æ‰¹å‡†ï¼Œä»»ä½•å‘èµ·è€…å‘èµ·çš„æ›´é«˜ç¼–å·çš„ææ¡ˆå€¼å¿…é¡»æ˜¯vã€‚

æˆ‘ä»¬æ¥è¯æ˜P2bå¦‚ä½•ä¿è¯P2ã€‚

ä½¿ç”¨å½’çº³æ³•ï¼Œå‡è®¾ç¼–å·ä¸ºmï¼ˆm < nï¼‰çš„ææ¡ˆè¢«é€‰ä¸­ï¼Œä¸”måˆ°n-1çš„ææ¡ˆå€¼éƒ½ä¸ºvï¼Œé‚£ä¹ˆå­˜åœ¨ä¸€ä¸ªå¤§å¤šæ•°æ¥æ”¶è€…çš„é›†åˆCæ¥æ”¶äº†mææ¡ˆï¼Œè¿™æ„å‘³ç€ï¼š

>Cä¸­æ¯ä¸ªæ¥æ”¶è€…éƒ½æ‰¹å‡†äº†måˆ°n-1å…¶ä¸­ä¸€ä¸ªææ¡ˆï¼Œmåˆ°n-1çš„æ¯ä¸ªè¢«æ‰¹å‡†çš„ææ¡ˆå…¶å€¼éƒ½æ˜¯vã€‚

å› ä¸ºä»»ä½•å¤§å¤šæ•°æ¥æ”¶è€…é›†åˆSï¼Œå’ŒCè‡³å°‘æœ‰ä¸€ä¸ªå…¬å…±æ¥æ”¶è€…ï¼Œç¼–å·ä¸ºnçš„ææ¡ˆwè¢«æ‰¹å‡†ï¼Œé‚£ä¹ˆåªæœ‰ä¸¤ç§æƒ…å†µï¼š
>
>1. å­˜åœ¨ä¸€ä¸ªåŒ…å«å¤§å¤šæ•°æ¥æ”¶è€…çš„é›†åˆSï¼Œä»æœªæ¥å—è¿‡å°äºnçš„ææ¡ˆã€‚
>2. wå’ŒSä¸­æ‰€æœ‰å·²æ¥å—çš„ã€ç¼–å·å°äºnçš„æœ€å¤§ç¼–å·ææ¡ˆå€¼ç›¸åŒï¼Œå³å€¼ä¸ºvã€‚å› ä¸ºå…¬å…±æ¥æ”¶è€…éœ€è¦æ‰¹å‡†ç›¸åŒçš„ææ¡ˆå€¼ã€‚
>
è¿™ä¸ªè¯æ˜çœ‹èµ·æ¥å¾ˆå¤šä½™ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œç¼–å·måˆ°nçš„ææ¡ˆä¸æ˜¯æŒ‰ç¼–å·å…ˆåé¡ºåºå‘èµ·çš„ï¼Œè¿™äº›ææ¡ˆçš„å‘èµ·é¡ºåºæ˜¯æ²¡æœ‰ä¿è¯çš„ã€‚

ç¼–å·ä¸ºnææ¡ˆçš„å‘èµ·è€…éœ€è¦çŸ¥é“æ‰€æœ‰å·²æ¥å—ææ¡ˆä¸­å°äºnçš„æœ€å¤§ç¼–å·ææ¡ˆçš„å€¼ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚çŸ¥é“å·²æ¥å—çš„ææ¡ˆæ˜¯å€¼å¾ˆç®€å•çš„ï¼Œé¢„æµ‹æœªæ¥å¾ˆéš¾åŠï¼Œ
æ¯”å¦‚ï¼šç¼–å·ä¸ºnçš„ææ¡ˆå€¼ï¼Œå¦‚ä½•çŸ¥é“å°šæœªæ”¶åˆ°çš„n-1ç¼–å·ææ¡ˆçš„å€¼å‘¢ã€‚

ä¸å…¶é¢„æµ‹æœªæ¥ï¼Œä¸å¦‚è®©æ¥å—è€…åœ¨ä¹‹åæ‹’ç»æ‰€æœ‰å°äºnçš„ææ¡ˆã€‚

ç”±æ­¤å¼ºåŒ–çº¦æŸP1ï¼Œå¾—åˆ°P1a:
    
>æ¥æ”¶è€…æ‹’ç»æ¥å—ç¼–å·æ¯”å½“å‰å·²çŸ¥æœ€å¤§ç¼–å·næ›´å°çš„ææ¡ˆã€‚

å¾—åˆ°paxosç®—æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. prepareé˜¶æ®µï¼š
    1. å‘èµ·è€…é€‰æ‹©ä¸€ä¸ªææ¡ˆç¼–å·nå¹¶å°†prepareè¯·æ±‚å‘é€ç»™æ¥æ”¶è€…ä¸­çš„ä¸€ä¸ªå¤šæ•°æ´¾ï¼›
    2. æ¥æ”¶è€…æ”¶åˆ°prepareæ¶ˆæ¯åï¼Œå¦‚æœææ¡ˆçš„ç¼–å·å¤§äºå®ƒå·²ç»å›å¤çš„æ‰€æœ‰prepareæ¶ˆæ¯(å›å¤æ¶ˆæ¯è¡¨ç¤ºæ¥å—accept)ï¼Œ
åˆ™æ¥æ”¶è€…å°†è‡ªå·±ä¸Šæ¬¡æ¥å—çš„ææ¡ˆå›å¤ç»™å‘èµ·è€…ï¼Œå¹¶æ‰¿è¯ºä¸å†å›å¤å°äºnçš„ææ¡ˆï¼›å¦‚æœæ²¡æœ‰å›å¤è¿‡prepareæ¶ˆæ¯ï¼Œä¹Ÿæ‰¿è¯ºä¸å†å›å¤å°äºnçš„ææ¡ˆã€‚
2. accepté˜¶æ®µï¼š
    1. å½“ä¸€ä¸ªå‘èµ·è€…æ”¶åˆ°äº†å¤šæ•°æ¥æ”¶è€…å¯¹prepareçš„å›å¤åï¼Œå°±è¿›å…¥æ‰¹å‡†é˜¶æ®µã€‚
 å®ƒè¦å‘å›å¤prepareè¯·æ±‚çš„æ¥æ”¶è€…å‘é€acceptè¯·æ±‚ï¼ŒåŒ…æ‹¬ç¼–å·nå’Œprepareé˜¶æ®µè¿”å›çš„å°äºnçš„æœ€å¤§ææ¡ˆçš„å€¼ã€‚
    2. å¦‚æœacceptçš„ææ¡ˆç¼–å·nå¤§äºç­‰äºæ¥æ”¶è€…å·²æ‰¿è¯ºçš„ç¼–å·å€¼ï¼Œæ¥æ”¶è€…å°±æ‰¹å‡†è¿™ä¸ªè¯·æ±‚ã€‚
    3. acceptè¢«å¤šæ•°æ´¾æ‰¹å‡†åï¼Œå‘èµ·è€…å†é€šçŸ¥æ‰€æœ‰æ¥æ”¶è€…ææ¡ˆå·²æ‰¹å‡†ï¼ˆdecided)çš„æ¶ˆæ¯ã€‚
 
## å®ç°å¤åˆ¶çŠ¶æ€æœº
[KeyValueEngine](./javadoc/io/github/parliament/kv/KeyValueEngine.html)æ”¶åˆ°è¯·æ±‚ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œï¼Œ
è€Œæ˜¯äº¤ç»™[ReplicateStateMachine](./javadoc/io/github/parliament/ReplicateStateMachine.html)ç”Ÿæˆä¸€ä¸ªæ–°çš„çŠ¶æ€æœºè¾“å…¥ï¼Œ
å¹¶å§”æ‰˜ReplicateStateMachineå¯¹è¯¥è¾“å…¥æ‰€åœ¨ç¼–å·çš„æ“ä½œè¾¾æˆå…±è¯†ï¼Œç”±ReplicateStateMachineå›è°ƒKeyValueEngineæ¥å£æ‰§è¡Œï¼Œè¿”å›ç»“æœã€‚

```{.java}
Input input = rsm.newState(bytes);
CompletableFuture<Output> future = rsm.submit(input);
return future.thenApply((output) -> {
    try {
        if (!Arrays.equals(input.getUuid(), output.getUuid())) {
            return RespError.withUTF8("å…±è¯†å†²çª");
        }
        return RespDecoder.create().decode(output.getContent()).get();
    } catch (Exception e) {
        logger.error("get submit result failed:", e);
        return RespError.withUTF8("get submit result failed:" + e.getClass().getName()
                + ",message:" + e.getMessage());
    }
});
```
å¦‚æœè¾¾æˆçš„å…±è¯†å†…å®¹ä¸æ˜¯æäº¤çš„å†…å®¹ï¼Œè¿”å›å®¢æˆ·ç«¯é”™è¯¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥å†³å®šé‡è¯•æˆ–æŠ¥é”™ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚éœ€è¦åˆ†é…ç‹¬ç«‹çš„idï¼Œä»¥åŒºåˆ†ç›¸åŒå†…å®¹çš„å®¢æˆ·è¯·æ±‚ï¼Œå‡å¦‚å®ç°å‘½ä»¤appendï¼Œä¸ºkeyå¯¹åº”çš„valueè¿½åŠ å†…å®¹ï¼Œä¸¤ä¸ªç›¸åŒçš„"append x y"è¯·æ±‚å¦‚ä¸åŠ idä¼šè¾¾æˆä¸€æ¬¡å…±è¯†ï¼Œä½†å®é™…åªæ‰§è¡Œäº†ä¸€æ¬¡ï¼Œ
valueåªè¿½åŠ äº†ä¸€ä¸ªyã€‚è¿™ä¸å®¢æˆ·é¢„æœŸä¸ä¸€è‡´ï¼Œå¯¼è‡´bugã€‚è§£å†³æ–¹æ³•æ˜¯ä¸ºå¾…å…±è¯†å†…å®¹å¢åŠ ä¸€ä¸ªuuidï¼š
```{.java}
public Input newState(byte[] content) throws DuplicateKeyException {
    return Input.builder().id(next()).uuid(uuid()).content(content).build();
}
```

ReplicateStateMachineå¯ä»¥å¹¶å‘è¿›è¡Œå¤šä¸ªPaxoså…±è¯†å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹é€’å¢åˆ†é…ä¸€ä¸ªç¼–å·ï¼Œæ‰€æœ‰RSMå®ä¾‹éƒ½æŒ‰ç…§ç¼–å·é¡ºåºï¼Œä½¿ç”¨åå°çº¿ç¨‹é¡ºåºæ‰§è¡Œæ‰€æœ‰ç¼–å·çš„å…±è¯†ç»“æœã€‚

é¡ºåºæ‰§è¡Œæ„å‘³ç€KeyValueEngineæ— æ³•å¹¶å‘å¤„ç†å·²å®Œæˆå…±è¯†çš„å„ä¸ªè¯·æ±‚ï¼Œå¦‚æœéœ€è¦æé«˜å¹¶å‘æ€§ï¼Œéœ€è¦ä¿è¯ä¸åŒæœºå™¨å¹¶å‘æ‰§è¡Œçš„ç»“æœä¸€æ ·ï¼Œè¿™æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œ
éœ€è¦å®Œå–„å„ç§é”æœºåˆ¶å’Œå¹¶å‘æ§åˆ¶ï¼Œè¿™é‡Œä¸åšå®ç°ã€‚

è¿›ç¨‹å¯èƒ½åœ¨KeyValueEngineæ‰§è¡Œæ•°æ®æ“ä½œå‘½ä»¤è¿‡ç¨‹ä¸­å¤±è´¥ï¼Œæˆ–è€…æ‰§è¡Œå®Œæˆï¼Œä½†åœ¨è¿”å›ReplicateStateMachineå‰å¤±è´¥ï¼ŒæœåŠ¡éœ€è¦åœ¨æ¢å¤æ—¶æ¢å¤ä¹‹å‰çš„æ­£ç¡®çŠ¶æ€ã€‚
æ•°æ®åº“ä¸€èˆ¬éœ€è¦é‡‡ç”¨[å†™å‰æ—¥å¿—](https://en.wikipedia.org/wiki/Write-ahead_logging)æŠ€æœ¯ä¿è¯äº‹åŠ¡å¯æ¢å¤ã€‚

æœ¬åº”ç”¨çš„PUTã€DELã€GETéƒ½æ˜¯å¹‚ç­‰çš„ï¼Œé‡å¤æ‰§è¡Œæ²¡æœ‰é—®é¢˜ï¼Œåªè¦ä¿è¯ä¸æ¼æ‰å‘½ä»¤å°±è¡Œï¼ŒReplicateStateMachineçš„æ‰§è¡Œæ—¥å¿—å¯ä»¥ä¿è¯è¿™ä¸€ç‚¹ï¼Œ
å…·ä½“å¯æŸ¥çœ‹[start](./javadoc/io/github/parliament/ReplicateStateMachine.html#start(io.github.parliament.StateTransfer,java.util.concurrent.Executor))
å’Œ[apply](./javadoc/io/github/parliament/ReplicateStateMachine.html#apply())æ–¹æ³•ã€[done](./javadoc/io/github/parliament/ReplicateStateMachine.html#done(int))æ–¹æ³•ã€‚

ReplicateStateMachineå¹¶å‘æäº¤å…±è¯†è¯·æ±‚ç»™å…±è¯†æœåŠ¡[Coordinator](./javadoc/io/github/parliament/Coordinator.html)ï¼Œ
Coordinatorå¯ä»¥ç”±å„ç§å…±è¯†ç®—æ³•å®ç°ã€‚

## å®ç°Paxoså…±è¯†ç®—æ³•
å®Œæˆä¸€æ¬¡å…±è¯†è¿‡ç¨‹çš„Paxos[ä¼ªä»£ç ](http://nil.csail.mit.edu/6.824/2015/notes/paxos-code.html)å¦‚ä¸‹ï¼š
```
--- Paxos Proposer ---
      	
     1	proposer(v):
     2    while not decided:
     2	    choose n, unique and higher than any n seen so far
     3	    send prepare(n) to all servers including self
     4	    if prepare_ok(n, na, va) from majority:
     5	      v' = va with highest na; choose own v otherwise   
     6	      send accept(n, v') to all
     7	      if accept_ok(n) from majority:
     8	        send decided(v') to all
      	
        
--- Paxos Acceptor ---

     9	acceptor state on each node (persistent):
    10	 np     --- highest prepare seen
    11	 na, va --- highest accept seen
      	
    12	acceptor's prepare(n) handler:
    13	 if n > np
    14	   np = n
    15	   reply prepare_ok(n, na, va)
    16   else
    17     reply prepare_reject
      	
      	
    18	acceptor's accept(n, v) handler:
    19	 if n >= np
    20	   np = n
    21	   na = n
    22	   va = v
    23	   reply accept_ok(n)
    24   else
    25     reply accept_reject
```

Paxosç®—æ³•æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå¦‚multi-paxoså¯ä»¥å‡å°‘ä¸€æ¬¡è¯·æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨åŸå§‹ç®—æ³•ã€‚

[Paxosç±»](./javadoc/io/github/parliament/paxos/Paxos.html)ä½œä¸ºPaxosæœåŠ¡çš„é—¨é¢ç±»ï¼Œæä¾›å…±è¯†è¯·æ±‚ã€å…±è¯†ç»“æœæŸ¥è¯¢ç­‰åŠŸèƒ½å…¥å£ã€‚
ä»–ä¸ºæ¯ä¸ªå…±è¯†å®ä¾‹åˆ›å»ºç›¸åº”çš„å‘èµ·è€…ï¼ˆproposer)ï¼ŒåŒæ—¶ä¸ºæœ¬èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹çš„å‘èµ·è€…åˆ›å»ºã€ç®¡ç†å¯¹åº”çš„æ¥æ”¶è€…ï¼ˆacceptor)ã€‚

[Proposer](./javadoc/io/github/parliament/paxos/proposer/Proposer.html)ä¸ºå‘èµ·è€…å®ç°ï¼Œ
[LocalAcceptor](./javadoc/io/github/parliament/paxos/acceptor/LocalAcceptor.html)ä¸ºæ¥æ”¶è€…å®ç°ã€‚

å„ä¸ªå®ä¾‹çš„ææ¡ˆè¯·æ±‚å¯èƒ½æ¥è‡ªå…¶ä»–èŠ‚ç‚¹ï¼Œæ‰€ä»¥æä¾›ä¸€ä¸ªç½‘ç»œæœåŠ¡[PaxosServer](./javadoc/io/github/parliament/paxos/server/PaxosServer.html)ï¼Œ
é€šè¿‡å‚æ•°ä¸­çš„ç¼–å·åŒºåˆ†ä¸åŒå…±è¯†è¿‡ç¨‹å®ä¾‹ï¼Œè½¬å‘ç»™ä¸åŒå®ä¾‹çš„æœ¬åœ°æ¥æ”¶è€…å¤„ç†ï¼Œç„¶åè¿”å›å“åº”ã€‚

é…å¥—çš„ï¼Œæä¾›[SyncProxyAcceptor](./javadoc/io/github/parliament/paxos/client/SyncProxyAcceptor.html)ä½œä¸ºè¿œç«¯æ¥æ”¶è€…çš„æœ¬åœ°ç½‘ç»œä»£ç†ï¼Œ
è¯·æ±‚å„ä¸ªPaxosServerå®Œæˆææ¡ˆè¿‡ç¨‹ã€‚

[InetPeerAcceptors](./javadoc/io/github/parliament/paxos/client/InetPeerAcceptors.html)ä¸ºSyncProxyAceptorçš„åˆ›å»ºå·¥å‚ï¼Œ
ä½¿ç”¨ä¸€ä¸ªç®€å•çš„[è¿æ¥æ± ](./javadoc/io/github/parliament/paxos/client/ConnectionPool.html)ä¸ºSyncProxyAcceptoræä¾›nio channelå®ä¾‹ã€‚

æ¥å£å‚æ•°ä½¿ç”¨RESPåè®®ç¼–è§£ç ï¼ŒSyncProxyAcceptorä½¿ç”¨åŒæ­¥ç½‘ç»œAPIï¼Œç®€åŒ–ä½¿ç”¨é€»è¾‘ã€‚
å¦‚prepareæ–¹æ³•çš„ä»£ç†ï¼š
```{.java}
Prepare delegatePrepare(int round, String n) throws IOException {
    synchronized (channel) {
        ByteBuffer request = codec.encodePrepare(round, n);
        while (request.hasRemaining()) {
            channel.write(request);
        }

        return codec.decodePrepare(channel, n);
    }
}
```

### æ­£ç¡®æ€§ä¿è¯
ä¸Šé¢çš„ä¼ªä»£ç å¾ˆç®€å•ï¼Œä½†æ˜¯åœ¨è¿›ç¨‹å¯èƒ½å¼‚å¸¸é€€å‡ºçš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸å¤Ÿå®Œå¤‡çš„ã€‚è¿›ç¨‹è¢«æ€æ­»ã€æ–­ç”µéƒ½ä¼šå¯¼è‡´æ­£åœ¨å…±è¯†åå•†çš„è¿›ç¨‹é€€å‡ºï¼Œå¹¶åœ¨æ¢å¤åï¼Œå‡ºç°é”™è¯¯çš„ç»“æœã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¤šæ•°æ´¾ä¸ºæŸä¸ªç¼–å·çš„å…±è¯†å®ä¾‹é€šè¿‡äº†ä¸€ä¸ªææ¡ˆï¼Œä½†æ˜¯åœ¨decideé˜¶æ®µï¼Œå¤šæ•°æ´¾å…¨éƒ¨å¼‚å¸¸é€€å‡ºï¼Œåªæœ‰å¤šæ•°æ´¾ä»¥å¤–çš„èŠ‚ç‚¹å¤„ç†äº†ææ¡ˆç»“æœã€‚
ç¨åè¿™äº›å¤šæ•°æ´¾åˆæ¢å¤ï¼Œä¹‹å‰çš„ä¿¡æ¯å·²ç»ä¸¢å¤±ï¼Œæ­¤æ—¶åˆæ”¶åˆ°åŒä¸€ä¸ªå…±è¯†å®ä¾‹ç¼–å·çš„å¦ä¸€ä¸ªææ¡ˆï¼Œæ­¤ææ¡ˆè¢«é€šè¿‡ï¼Œå’Œæœªå¼‚å¸¸é€€å‡ºçš„èŠ‚ç‚¹æ¥å—çš„ææ¡ˆä¸ä¸€è‡´ã€‚

æ‰€ä»¥ï¼Œåœ¨prepareå’Œaccepté˜¶æ®µï¼Œéƒ½éœ€è¦æŒä¹…åŒ–Acceptorçš„çŠ¶æ€ï¼Œå®ä¾‹åŒ–Acceptoræ—¶ï¼Œå…ˆå°è¯•æ¢å¤å·²æŒä¹…åŒ–çš„çŠ¶æ€ã€‚
å¹¶é€šè¿‡å®šæœŸ[å­¦ä¹ ](./javadoc/io/github/parliament/ReplicateStateMachine.html#catchUp())å…¶ä»–èŠ‚ç‚¹çš„å…±è¯†ç»“æœï¼Œå¿«é€Ÿèµ¶ä¸Šè¿›åº¦ã€‚

å¦‚[LocalAcceptor](./javadoc/io/github/parliament/paxos/acceptor/LocalAcceptor.html)çš„prepareï¼š
```{.java}
@Override
public synchronized Prepare prepare(String n) throws Exception {
    if (np == null || n.compareTo(np) > 0) {
        np = n;
        persistence(); // ä¿å­˜çŠ¶æ€
        return Prepare.ok(n, na, va);
    }
    return Prepare.reject(n);
}
```
[Paxosç±»](./javadoc/io/github/parliament/paxos/Paxos.html)ä¿å­˜å’Œæ¢å¤acceptorçš„æ–¹æ³•åˆ†åˆ«å¦‚ä¸‹ï¼š
```{.java}
void persistenceAcceptor(int round, LocalAcceptor acceptor) throws IOException, ExecutionException {
    if (Strings.isNullOrEmpty(acceptor.getNp())) {
        return;
    }
    persistence.put((round + "np").getBytes(), acceptor.getNp().getBytes());
    if (!Strings.isNullOrEmpty(acceptor.getNa())) {
        persistence.put((round + "na").getBytes(), acceptor.getNa().getBytes());
    }
    if (acceptor.getVa() != null) {
        persistence.put((round + "va").getBytes(), acceptor.getVa());
    }
}

Optional<LocalAcceptor> regainAcceptor(int round) throws IOException, ExecutionException {
    byte[] np = persistence.get((round + "np").getBytes());

    if (np == null) {
        return Optional.empty();
    }
    byte[] na = persistence.get((round + "na").getBytes());
    byte[] va = persistence.get((round + "va").getBytes());

    String nps = new String(np);
    String nas = na == null ? null : new String(na);

    return Optional.of(new LocalAcceptorWithPersistence(round, nps, nas, va));
}
```

è¾“å…¥ä¸€ç›´åœ¨å¢é•¿ï¼Œéœ€è¦åˆ é™¤å…±è¯†æœåŠ¡ä¸­å·²ç»å¤„ç†å®Œæˆçš„è¾“å…¥ï¼Œè§[forgetæ–¹æ³•](./javadoc/io/github/parliament/ReplicateStateMachine.html#forget())ã€‚
### æ´»è·ƒæ€§é—®é¢˜
æ ¹æ®[FLPä¸å¯èƒ½åŸç†](https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/)ï¼š

>ä»»ä½•åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œåªè¦æœ‰ä¸€ä¸ªè¿›ç¨‹å®•æœºï¼Œå‰©ä½™çš„è¿›ç¨‹å­˜åœ¨æ°¸è¿œæ— æ³•è¾¾æˆå…±è¯†çš„å¯èƒ½æ€§ã€‚

å¯¹äºPaxosç®—æ³•ï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°æ— æ³•è¾¾æˆå…±è¯†çš„æƒ…å†µï¼Œæ¯”å¦‚ä¸åŒproposerçš„acceptæ¯æ¬¡éƒ½å› å…¶ä»–proposeräº§ç”Ÿçš„æ›´é«˜prepareç¼–å·è€Œacceptorè¢«æ‹’ç»ã€‚
è§£å†³åŠæ³•æ˜¯åœ¨å¯èƒ½å†²çªæ—¶ï¼Œå¼•å…¥éšæœºç­‰å¾…ï¼Œé™ä½è¿™ç§å¯èƒ½æ€§ï¼Œå¹¶åœ¨é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°æ—¶ï¼Œå¤±è´¥é€€å‡ºã€‚å¦‚ï¼š
```{.java}
if (!decided) {
    retryCount++;
    try {
        Thread.sleep(Math.abs(random.nextInt()) % 300);
    } catch (InterruptedException e) {
        logger.error("Failed in propose.", e);
        return null;
    }
    if (retryCount >= 7) {
        logger.error("Failed in propose.Retried {} times.", 7);
        throw new IllegalStateException();
    }
}
```
å¦‚æœå»æ‰è¿™ä¸ªéšæœºç­‰å¾…ï¼Œåœ¨å¤šæ ¸æœºå™¨è¿è¡Œå•å…ƒæµ‹è¯•éå¸¸å®¹æ˜“å‡ºç°é‡è¯•å¤±è´¥ã€‚

## æ€»ç»“
åˆ°è¿™é‡Œï¼Œç³»ç»ŸåŸºæœ¬åŠŸèƒ½å°±å®Œæˆäº†ã€‚æˆ‘ä»¬çš„ç³»ç»Ÿå¾ˆç®€å•ï¼Œä½†æ˜¯ä½å¹¶å‘çš„åœºæ™¯ï¼Œä¹Ÿå¤Ÿç”¨äº†ã€‚

æˆ‘ä»¬åªä¿è¯äº†é«˜å¯ç”¨ï¼Œå¦‚æœè¦ä¿è¯å®¹é‡å’Œç³»ç»Ÿååé‡ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ‡åˆ†ï¼ˆshardingï¼‰ï¼Œä¸åŒæœºå™¨å¤„ç†ä¸åŒèŒƒå›´çš„æ•°æ®ï¼Œ
æ•°æ®èŒƒå›´çš„åˆ’åˆ†å¯ä»¥ä¼šéšç³»ç»Ÿå®¹é‡è€Œä¸æ–­å˜åŒ–ï¼Œè¿™æ„å‘³ç€æœ¬èº«åœ¨Aæœºå™¨çš„æ•°æ®ï¼Œå¯èƒ½éœ€è¦ç§»åŠ¨åˆ°Bæœºå™¨ä¸Šï¼Œè¯»è€…å¯ä»¥æ€è€ƒä¸€ä¸‹å¦‚ä½•åœ¨æ•°æ®åˆ‡åˆ†å˜åŒ–æ—¶ä¿è¯é¡ºåºä¸€è‡´æ€§ã€‚

æˆ‘ä»¬çš„SkipListæ²¡æœ‰å®ç°å¹¶å‘å¤„ç†ï¼Œä¸€ç§æ€è·¯æ˜¯å¯¹ä¸€å®šæ—¶é—´å†…å®Œæˆå…±è¯†çš„å¤šä¸ªè¯·æ±‚å¹¶å‘å¤„ç†ï¼Œè¯»è€…å¯ä»¥è¿›ä¸€æ­¥æ€è€ƒä¸åŒè¿›ç¨‹çš„å¹¶å‘å¤„ç†ç»“æœå¦‚ä½•ä¿è¯ä¸€è‡´ï¼Ÿ

