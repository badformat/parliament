# åˆ†å¸ƒå¼ç³»ç»Ÿå®è·µå…¥é—¨ï¼šä»¥å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼æœåŠ¡ä¸ºä¾‹

>â€œWhat I cannot create, I do not understand.â€ â€“ Richard Feynman

ğŸš§æ³¨æ„ï¼šéç»ˆç¨¿ï¼Œä¸å®šæœŸæ›´æ–°ã€‚

## èƒŒæ™¯

æ‰€è°“åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ˜¯ç”±å¤šå°æœºå™¨é€šè¿‡ç½‘ç»œé€šä¿¡ååŒå®Œæˆç›¸å…³åŠŸèƒ½çš„ç³»ç»Ÿã€‚å­˜åœ¨å¤šå°æœºå™¨çš„åŸå› å¯èƒ½æœ‰ï¼š

- ç³»ç»Ÿå„ä¸ªæ¨¡å—çš„æ‰€æœ‰è€…ã€è¿è¡Œç¯å¢ƒã€æ¶æ„ä½“ç³»ã€å‘å¸ƒé¢‘ç‡ç­‰å®¢è§‚æ¡ä»¶ä¸åŒï¼Œéœ€è¦å¤šå°æœºå™¨ã€‚
- å•æœºæ— æ³•æ»¡è¶³æ€§èƒ½æˆ–å®¹é‡è¦æ±‚ï¼Œéœ€è¦å¤šå°æœºå™¨ã€‚
- ä½¿ç³»ç»Ÿå¯¹æŸäº›è½¯ç¡¬ä»¶é”™è¯¯å®ç°å®¹é”™ã€‚

å…¶ä¸­ï¼Œå®¹é”™ç»å¸¸å’Œé«˜å¯ç”¨ã€ç¾å¤‡æ··æ·†ã€‚å¯ä»¥é€šè¿‡ä¾‹å­ç®€å•çš„[åŒºåˆ†](http://www.pbenson.net/2014/02/the-difference-between-fault-tolerance-high-availability-disaster-recovery/)ï¼š

- ç¾å¤‡ï¼šå‘ç”Ÿæ•…éšœåï¼ˆå°åˆ°ç¡¬ç›˜æŸåï¼Œè¾¾åˆ°æœºæˆ¿ç«ç¾ï¼‰ï¼ŒåæœŸä¸šåŠ¡çš„æ¢å¤èƒ½åŠ›ã€‚å¦‚é£èˆ¹æ•‘ç”Ÿèˆ±ã€‚
- é«˜å¯ç”¨ï¼šç³»ç»Ÿå‘ç”Ÿæ•…éšœåï¼Œå¯ä»¥å¿«é€Ÿæ¢å¤ã€‚å¦‚æ±½è½¦çš„å¤‡èƒã€‚
- å®¹é”™ï¼šç³»ç»Ÿå…è®¸æŸäº›æ•…éšœå‘ç”Ÿï¼Œå¹¶ä¸”ä¿è¯åœ¨ä¿®å¤å‰ï¼Œç”¨æˆ·åŠŸèƒ½ä¸å—å½±å“ã€‚å¦‚å¤§å‹å®¢æœºçš„å¤šå¼•æ“è®¾è®¡ã€‚

åœ¨è½¯ä»¶è®¾è®¡ä¸­ï¼Œâ€œå®¹é”™â€éš¾åº¦è¾ƒå¤§ï¼Œå®ç°å®¹é”™çš„æŠ€æœ¯åŠæ€æƒ³ï¼Œå¸¸å¸¸ä¹Ÿç”¨åœ¨é«˜å¯ç”¨å’Œç¾å¤‡çš„è®¾è®¡ä¸­ã€‚

é‚£ä¹ˆï¼š**å®ç°ä¸€ä¸ªä»¥å®¹é”™ä¸ºç›®æ ‡çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæœ‰å“ªäº›æŒ‘æˆ˜å’Œåº”å¯¹æ‰‹æ®µï¼Ÿ**

æœ¬æ–‡ä»¥kvæœåŠ¡ä¸ºä¾‹ï¼Œé¦–å…ˆåˆ†æå¸¸è§çš„å‰¯æœ¬è®¾è®¡é—®é¢˜ã€è§£å†³åŠæ³•å’Œå±€é™ï¼Œç„¶åè®²è§£å®ç°ä¸€ä¸ªå•æœºkvæœåŠ¡çš„å…³é”®ç»†èŠ‚ï¼Œ
åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå†è®²è§£ä½¿ç”¨å¤åˆ¶çŠ¶æ€æœºå®ç°çš„å¯å®¹é”™åˆ†å¸ƒå¼kvæœåŠ¡ã€‚

é¡¹ç›®æºç åŠæ„å»ºã€è¿è¡Œæ–¹å¼è¯·å‚çœ‹ï¼š[é¡¹ç›®ä¸»é¡µ](https://github.com/z42y/parliament/)ï¼ŒåŒæ—¶æä¾›äº†[javadocå‚è€ƒ](https://z42y.github.io/parliament/javadoc//index.html)ã€‚

æ¬¢è¿åœ¨githubæå‡ºå»ºè®®ï¼ğŸ‘ 

## ç›®æ ‡

è¯¥æœåŠ¡é™¤äº†å®ç°å¸¸è§çš„"SET _key_ _value_"ã€"GET _key_"ã€"DEL _key0_  \[_key1_ ...\]"æ“ä½œï¼Œ
è¿˜å®ç°äº†æŒ‰èŒƒå›´å–å€¼çš„å‘½ä»¤"RANGE _begin_ _end_"ï¼Œå…¶ä¸­beginå’Œendä¸ºå¼€å§‹ã€ç»“æŸkeyå€¼ï¼Œå­—å…¸åºæ’åºã€‚

æœåŠ¡ä½¿ç”¨redisçš„respåè®®è¿›è¡Œé€šä¿¡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨redis-cliç­‰å®¢æˆ·ç«¯è¿æ¥æµ‹è¯•ã€‚

è¯¥æœåŠ¡æœ‰å®¹é”™èƒ½åŠ›ï¼Œå¹¶ä¸”åŒæ—¶ä¿è¯é¡ºåºä¸€è‡´æ€§ï¼š

>the result of any execution is the same as if the operations of all the processors were executed in some sequential order, and the operations of each individual processor appear in this sequence in the order specified by its program. - - Lamport

- æ‰§è¡Œç»“æœæ˜¯æ‰€æœ‰è¿›ç¨‹çš„æ“ä½œæŒ‰æŸä¸ªé¡ºåºæ‰§è¡Œçš„æ‰§è¡Œç»“æœã€‚
- æ¯ä¸ªè¿›ç¨‹çš„æ“ä½œï¼Œåœ¨ä¸Šé¢çš„é¡ºåºä¸­ï¼Œä¸è¯¥è¿›ç¨‹ç¨‹åºæŒ‡å®šçš„é¡ºåºä¸€è‡´ã€‚

æ¯”å¦‚ï¼Œå®¢æˆ·ç«¯1æ‰§è¡Œï¼š

	put(x,1),put(y,2),get(x),get(y)
	
å®¢æˆ·ç«¯2æ‰§è¡Œï¼š

	put(z,3),put(y,3),get(x),get(z)
	
åœ¨æœåŠ¡å™¨ä¸Šå¯èƒ½çš„ä¸€ç§ç»“æœæ˜¯ï¼š

	put(x,1),put(z,3),put(y,2),put(y,3),get(x),get(y),get(x),get(z)
	
ä»¥ä¸‹ç»“æœæ˜¯é¡ºåºä¸€è‡´æ€§ä¸å…è®¸çš„ï¼š
	
	put(x,1),put(y,2),put(y,3),put(z,3),get(x),get(z),get(x),get(y)
	
å› ä¸ºput(z,3)å‘ç”Ÿput(y,3)åé¢ï¼Œè¿™ä¸æ˜¯å®¢æˆ·ç«¯2ç¨‹åºæŒ‡å®šçš„é¡ºåºã€‚

ä¸åŒå®¢æˆ·ç«¯çœ‹åˆ°ä¸åŒçš„æ€»ä½“æ‰§è¡Œé¡ºåºä¹Ÿæ˜¯ä¸å…è®¸çš„ã€‚

è¿™äº›ç³»ç»Ÿå¯¹å®¢æˆ·ç«¯ä½œå‡ºçš„ä¿è¯å°±æ˜¯ç³»ç»Ÿçš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¸åŒç³»ç»Ÿæœ‰ä¸åŒçš„[ä¸€è‡´æ€§æ¨¡å‹](https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B)ï¼Œè¿™é‡Œçš„ä¿è¯å±äºé¡ºåºä¸€è‡´æ€§ã€‚

ä¸€è‡´æ€§æ¨¡å‹æœ‰å¼ºå¼±ä¹‹åˆ†ï¼Œä¸€è‡´æ€§è¶Šå¼ºï¼Œå¯¹åº”ç”¨ç¨‹åºæˆ–ç¨‹åºå‘˜è¶Šå‹å¥½ï¼Œä½†æ˜¯å®ç°éš¾åº¦æ›´å¤§ï¼Œæ€§èƒ½æ›´å·®ï¼›åä¹‹ï¼Œä¸€è‡´æ€§è¶Šå¼±ï¼Œä¸€èˆ¬å®ç°æ›´ç®€å•ï¼Œæ€§èƒ½æ›´å¥½ï¼Œä½†å¯¹åº”ç”¨è€…æ›´åŠ ä¸å‹å¥½ã€æ›´ä¸å¯é¢„æµ‹ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢å°†ä½“ä¼šåˆ°è¿™ç‚¹ã€‚

## ä»ç¾å¤‡åˆ°å®¹é”™

### ä¸»ä»å¤åˆ¶

å¯¹äºé”®å€¼æœåŠ¡ç­‰æ•°æ®ç±»å‹åº”ç”¨ï¼Œä¸»ä»å¤åˆ¶æ˜¯æœ€å¸¸è§çš„ç¾å¤‡æ‰‹æ®µï¼Œä¸€å°æœºå™¨æä¾›æœåŠ¡ï¼Œå¦ä¸€å°æœºå™¨é€šè¿‡ç½‘ç»œå¯¹è¿™å°æœºå™¨çš„æ•°æ®è¿›è¡Œæœ¬åœ°å¤‡ä»½ã€‚
å¦‚å›¾ï¼š

![ä¸»ä»å¤åˆ¶](./pb.png)

ä¸»ä»å¤åˆ¶åˆ†ä¸ºåŒæ­¥æ–¹å¼å’Œå¼‚æ­¥æ–¹å¼ï¼ŒåŒæ­¥æ–¹å¼æ˜¯æŒ‡è¯·æ±‚å¤‡ä»½æˆåŠŸåè¿”å›æˆåŠŸï¼Œå¼‚æ­¥æ˜¯æŒ‡å…ˆè¿”å›ç»“æœå†è¿›è¡ŒåŒæ­¥ã€‚

### å•ç‚¹æ•…éšœ

ä¸»ä»æœºå™¨ä¸­ä»»ä½•ä¸€å°å‡ºç°æ•…éšœï¼Œéƒ½éœ€è¦æš‚åœæœåŠ¡ï¼Œæ¢å¤åï¼Œæ‰èƒ½ç»§ç»­æä¾›æœåŠ¡ï¼Œå¦åˆ™å¯èƒ½å‡ºç°æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚

å¯ä»¥æä¾›å¤šå°ä»èŠ‚ç‚¹æé«˜å¯ç”¨æ€§ï¼Œåªè¦æœ‰ä¸€å°ä»èŠ‚ç‚¹å¯ç”¨ï¼ŒæœåŠ¡å¯ä»¥ä¸ç”¨æš‚åœã€‚
å¦‚å›¾ï¼š

![é«˜å¯ç”¨ä¸»ä»å¤åˆ¶](./pb2.png)

ä½†æ˜¯æŸäº›èŠ‚ç‚¹å’Œç½‘ç»œé“¾è·¯å¯èƒ½ä¸€ä¼šå„¿æ­£å¸¸ï¼Œä¸€ä¼šå„¿å¤±è´¥ï¼Œå¯¼è‡´èŠ‚ç‚¹æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦é¢å¤–çš„å·¥ä½œä½¿å„ä¸ªä»èŠ‚ç‚¹æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚

é™¤äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸»ä»å¤åˆ¶æ–¹æ¡ˆè¿˜å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼Œåªè¦ä¸»èŠ‚ç‚¹å¤±è´¥ï¼Œæ•´ä¸ªæœåŠ¡éƒ½ä¸å¯ç”¨ï¼Œæ— æ³•æ»¡è¶³æˆ‘ä»¬çš„å®¹é”™éœ€æ±‚ã€‚

## å‰¯æœ¬å®¹é”™

ä¸ºäº†å®¹é”™ï¼Œæˆ‘ä»¬å¯æä¾›å¤šä¸ªæœåŠ¡è¿›ç¨‹çš„å‰¯æœ¬ï¼Œæ”¶åˆ°è¯·æ±‚çš„èŠ‚ç‚¹ä½¿ç”¨æŸç§æ ¼å¼çš„æ—¥å¿—è®°å½•è¯¥è¯·æ±‚ï¼Œå¹¶åŒæ­¥ç»™å„ä¸ªèŠ‚ç‚¹æ‰§è¡Œã€‚

å½“æŸä¸ªèŠ‚ç‚¹å®•æœºæˆ–ç½‘ç»œä¸å¯è¾¾æ—¶ï¼Œå¦ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥ç»§ç»­ä¸ºå®¢æˆ·æä¾›æœåŠ¡ï¼Œå®•æœºèŠ‚ç‚¹æ¢å¤åï¼Œ
å®ƒå¯ä»¥ä»å…¶ä»–èŠ‚ç‚¹è·å–å®•æœºåçš„æ—¥å¿—è¿›è¡Œå›æ”¾ï¼Œèµ¶ä¸Šå…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€ã€‚

### ç½‘ç»œåˆ†åŒºçš„é—®é¢˜

ä½†æ˜¯ï¼Œç½‘ç»œåˆ†åŒºä¼šä½¿å¾—ä¸åŒå®¢æˆ·ç«¯å¯èƒ½ä¼šä½¿ç”¨ä¸åŒèŠ‚ç‚¹è¿›è¡Œè¯»å†™è¯·æ±‚ï¼Œå¦‚ï¼š

![ç½‘ç»œåˆ†åŒº](./pb3.png)

æŸä¸ªæ—¶å€™å¼€å§‹ï¼ŒèŠ‚ç‚¹1ä¸å…¶ä»–èŠ‚ç‚¹æ— æ³•é€šä¿¡ï¼Œåˆ†ä¸ºä¸¤ä¸ªç½‘ç»œï¼Œ
åº”ç”¨1å…ˆåœ¨èŠ‚ç‚¹1çš„ç½‘ç»œåˆ†åŒºï¼Œåº”ç”¨2åœ¨èŠ‚ç‚¹2çš„ç½‘ç»œåˆ†åŒºï¼Œæ‰§è¡Œå†™æ“ä½œï¼Œ
æ¥ç€ï¼Œåº”ç”¨1å’Œ2çš„åˆ†åŒºåŒæ—¶è¿›è¡Œäº†åˆ‡æ¢ï¼Œè¿›è¡Œå¦ä¸€æ­¥çš„è¯»æ“ä½œã€‚

```
åº”ç”¨1ï¼šput(x,1),get(x)=2
åº”ç”¨2ï¼šput(x,2),get(x)=1
```

ä»¥ä¸Šç»“æœè¿èƒŒäº†é¡ºåºä¸€è‡´æ€§ï¼Œåº”ç”¨1çš„get(x)=2è¯´æ˜åº”ç”¨2çš„put(x,2)å·²æ‰§è¡Œï¼Œåº”ç”¨2çš„get(x)è¿”å›å€¼åº”ä¸º2ã€‚

å¦‚æœå‘ç”Ÿå†™å†²çªåèƒ½å¤Ÿç«‹åˆ»å‘ç°å’Œè§£å†³å†²çªï¼Œè¿˜æ˜¯èƒ½æ»¡è¶³è¾ƒå¼ºä¸€è‡´æ€§çš„ã€‚
ä¸€ç§æ–¹æ¡ˆæ˜¯ä¸€æ¬¡å†™æ“ä½œéœ€å†™å…¥wä¸ªèŠ‚ç‚¹ï¼Œè¯»æ“ä½œè¯»å–rä¸ªèŠ‚ç‚¹ï¼Œä¿è¯r+w>n(ç³»ç»Ÿæ‰€æœ‰èŠ‚ç‚¹çš„ä¸ªæ•°ï¼‰ï¼Œå°±ä¸€å®šèƒ½å‘ç°å†²çªã€‚å¦‚å›¾ï¼š

![r=3,w=3,n=5](./rwn.png)

ä¸Šå›¾åº”ç”¨2åœ¨èŠ‚ç‚¹3çš„è¯»å–æ“ä½œä¾¿å‘ç°äº†å†²çªï¼Œå®¢æˆ·ç«¯éœ€è¦æŸç§ç­–ç•¥ç¡®å®šä¿ç•™ä¸€ä¸ªç‰ˆæœ¬ã€‚

ä¸€ç§å¸¸è§æ€è·¯æ˜¯æ›´æ–°æ—¶å¸¦ä¸Šè¯¥æ•°æ®æ›´æ–°æ—¶é—´ï¼ŒæœåŠ¡ç«¯ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œæ—¶é’Ÿæ˜¯ä¸å¯é çš„ï¼Œæ¯å°æœºå™¨çš„æ—¶é’Ÿä¸å¯èƒ½å®Œå…¨åŒæ­¥ï¼Œåšåˆ°æ¥è¿‘çš„ä»£ä»·éƒ½å¾ˆå¤§ã€‚

ä¸å¯é çš„æ—¶é’Ÿï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªåŠŸèƒ½éœ€è¦åº”ç”¨1å…ˆæ‰§è¡Œï¼š

```
put(x,1)
``` 

æ¥ç€åº”ç”¨2æ‰§è¡Œï¼š

```
get(x);
if x == 1:
	put(x,2)
```

ä½†ç”±äºåº”ç”¨2çš„æ—¶é’Ÿæ¯”åº”ç”¨1æ…¢100æ¯«ç§’ï¼Œå¯¼è‡´put(x,2)è¢«ä½œä¸ºæ—§ç‰ˆæœ¬æ•°æ®è¢«ä¸¢å¼ƒï¼Œè¿™ä¸æ˜¯ä¸€ç§é¡ºåºæ‰§è¡Œçš„ç»“æœï¼Œ
è¿åäº†é¡ºåºä¸€è‡´æ€§ã€‚[é€»è¾‘æ—¶é—´](https://en.wikipedia.org/wiki/Logical_clock)æ˜¯ä¸€ç§è§£å†³åˆ†å¸ƒå¼æ—¶é—´é—®é¢˜çš„åŠæ³•ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœæŸä¸ªå®¢æˆ·ç«¯åº”ç”¨æ— æ³•è¿æ¥wä¸ªèŠ‚ç‚¹å’Œrä¸ªèŠ‚ç‚¹ï¼Œåˆ™æœåŠ¡å¯¹è¯¥å®¢æˆ·ç«¯ä¸å¯ç”¨ï¼Œ
å¦‚æœè¦æé«˜å¯ç”¨æ€§ï¼Œå¯ä»¥åœ¨è¯¥å®¢æˆ·ç«¯æ‰€åœ¨ç½‘ç»œåˆ†åŒºæ²¡æœ‰wä¸ªèŠ‚ç‚¹æ—¶ï¼Œæ–°å»ºå‰¯æœ¬æ»¡è¶³è¦æ±‚ï¼Œ
ä½†è¿™å°†ç ´åç³»ç»Ÿçš„ä¸€è‡´æ€§ï¼Œäºšé©¬é€ŠDynamoDBå°±æ˜¯è¿™ç§å®ç°æ–¹å¼ã€‚

æ‰€æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œéƒ½å­˜åœ¨ç€è¿™ç§ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¹‹é—´çš„[æƒè¡¡](http://dbmsmusings.blogspot.com/2010/04/problems-with-cap-and-yahoos-little.html)ã€‚

è™½ç„¶å¯ä»¥é€šè¿‡é€»è¾‘æ—¶é—´æ ‡è®°æ•°æ®ç‰ˆæœ¬è§£å†³ä¸€è‡´æ€§é—®é¢˜ï¼Œä½†æ˜¯å¯¹äºå¤æ‚åº”ç”¨ï¼Œå¦‚åˆ†å¸ƒå¼æ•°æ®åº“çš„SQLæ“ä½œï¼Œ
é€»è¾‘æ—¶é—´è§£å†³èµ·æ¥æ˜¯å¾ˆå¤æ‚çš„ã€‚

## å¤åˆ¶çŠ¶æ€æœº

å¦ä¸€ç§æƒ³æ³•æ˜¯é€‰ä¸¾ä¸€ä¸ªLeaderæ¥æ”¶è¯·æ±‚ï¼Œå½“å‰ä¸æ˜¯Leaderçš„èŠ‚ç‚¹æ‹’ç»å®¢æˆ·ç«¯è¯·æ±‚ã€‚
ä½†æ˜¯ï¼Œå¦‚ä½•ä¿è¯æ¯ä¸ªå®¢æˆ·ç«¯çš„Leaderæ˜¯ä¸€æ ·çš„å‘¢ï¼Ÿå¦‚æœåœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ï¼ŒLeaderå‘ç”Ÿäº†å˜åŒ–å‘¢ï¼Ÿ

å¯ä»¥çœ‹åˆ°ï¼Œè¦æ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼ŒLeaderæ›´æ–°è¿‡ç¨‹æœ¬èº«ä¹Ÿæ˜¯æ“ä½œçš„ä¸€éƒ¨åˆ†ï¼Œå’Œå…¶ä»–ä¸šåŠ¡è¯·æ±‚é¢å¯¹çš„é—®é¢˜ä¸€æ ·ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

	put(x,1),leader(server 1),put(x,2),leader(server 2)

è¿™ä¸ªé—®é¢˜çš„æœ¬è´¨æ˜¯ï¼Œæ‰€æœ‰èŠ‚ç‚¹åœ¨æ‰§è¡Œä¸€ä¸ªç‰¹å®šè¯·æ±‚æ—¶ï¼Œä»–ä»¬çš„çŠ¶æ€å¿…é¡»æ˜¯ä¸€æ ·çš„ã€‚
**å¦‚æœå°†è¿›ç¨‹çœ‹åšä¸€ä¸ªçŠ¶æ€æœºï¼Œé‚£ä¹ˆåœ¨å‰é¢è¾“å…¥éƒ½ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œå½“å‰è¾“å…¥çš„è¾“å‡ºç»“æœä¸€å®šæ˜¯ä¸€æ ·çš„**ã€‚

è¿™ä¾¿æ˜¯å¤åˆ¶çŠ¶æ€æœºçš„æ€æƒ³ï¼š

![å¤åˆ¶çŠ¶æ€æœº](./rms.png)

### å…±è¯†é—®é¢˜

å¦‚æœå¯¹å¤åˆ¶çŠ¶æ€ç»™çš„è¾“å…¥è¿›è¡Œé€’å¢ç¼–å·ï¼Œåªè¦ä¿è¯æ¯ä¸ªèŠ‚ç‚¹å¯¹ç›¸å…³ç¼–å·çš„è¾“å…¥å†…å®¹è¾¾æˆä¸€è‡´ï¼Œå³å¯å®ç°å¤åˆ¶çŠ¶æ€æœºï¼Œè¿™ç§åšæ³•ç§°ä¸ºå…¨åºå¹¿æ’­æˆ–åŸå­å¹¿æ’­ã€‚
å…¨åºå¹¿æ’­å¯ä»¥ä¿è¯é¡ºåºä¸€è‡´æ€§ã€‚

è¿™å°±æŠŠé—®é¢˜å˜æˆäº†ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼å…±è¯†é—®é¢˜ï¼š

>å¼‚æ­¥ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªè¿›ç¨‹å¯¹æŸä¸€ä¸ªææ¡ˆçš„å†…å®¹è¾¾æˆä¸€è‡´çš„è¿‡ç¨‹ï¼Œå°±æ˜¯å…±è¯†ã€‚

åå•†**æ¯ä¸ª**ç¼–å·æ“ä½œå†…å®¹çš„è¿‡ç¨‹ï¼Œå°±æ˜¯**ä¸€æ¬¡**åˆ†å¸ƒå¼å…±è¯†è¾¾æˆè¿‡ç¨‹ï¼Œå› æ­¤å…¨åºå¹¿æ’­é—®é¢˜åˆç­‰ä»·ä¸ºå…±è¯†é—®é¢˜ã€‚

åœ¨å¯èƒ½å­˜åœ¨ç½‘ç»œåˆ†åŒºçš„å¼‚æ­¥ç½‘ç»œä¸­ï¼Œå¸¸è§çš„å…±è¯†ç®—æ³•æœ‰Paxoså’Œraftï¼Œæˆ‘ä»¬ä½¿ç”¨Paxoså…±è¯†ç®—æ³•ã€‚

## ç†è§£Paxos

Paxosç®—æ³•çš„æ¨å¯¼è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªä¸ºäº†å¾—åˆ°ç»“æœï¼Œä¸æ–­å¯¹æ¡ä»¶è¿›è¡Œçº¦æŸçš„è¿‡ç¨‹ã€‚

é¦–å…ˆï¼ŒæŸä¸ªèŠ‚ç‚¹ä½œä¸ºå‘èµ·è€…ï¼ˆproposerï¼‰ï¼Œå¯¹å…¶ä»–èŠ‚ç‚¹å‘èµ·ææ¡ˆï¼Œæ¥æ”¶è€…éœ€è¦æ»¡è¶³**çº¦æŸP1**ï¼š

> P1ï¼šä¸€ä¸ª acceptor å¿…é¡»æ¥å—ï¼ˆacceptï¼‰ç¬¬ä¸€æ¬¡æ”¶åˆ°çš„ææ¡ˆã€‚
    
æ˜¾ç„¶ï¼Œè¿åP1çš„ç³»ç»Ÿï¼Œä¸ä¼šé€šè¿‡ä»»ä½•ææ¡ˆè¢«é€šè¿‡ã€‚

ä½†å¦‚æœç½‘ç»œåˆ†è£‚ä¸ºAå’ŒBä¸¤ä¸ªç½‘ç»œï¼ŒAå’ŒBä¸èƒ½äº’é€šï¼Œä¸€ä¸ªææ¡ˆåœ¨Aå¾—åˆ°æ‰¹å‡†ï¼Œå¦ä¸€ä¸ªææ¡ˆåœ¨Bç½‘ç»œå¾—åˆ°æ‰¹å‡†ï¼Œåˆ™ä¼šå‡ºç°ææ¡ˆä¸ä¸€è‡´çš„æƒ…å†µã€‚
è§£å†³æ–¹æ¡ˆæ˜¯åªæ‰¹å‡†è·å¾—è¶…è¿‡ä¸€åŠï¼ˆå¤§å¤šæ•°ï¼‰æ¥æ”¶è€…åŒæ„çš„ææ¡ˆã€‚

ä½†æ˜¯Aå’ŒBç½‘ç»œå¯èƒ½æœ‰é‡å ï¼Œæ­¤æ—¶æŸäº›èŠ‚ç‚¹å¯èƒ½ä¼šæ”¶åˆ°ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ææ¡ˆï¼Œè¿™äº›èŠ‚ç‚¹å¿…é¡»èƒ½å¤Ÿæ¥å—è¿™äº›ä¸¤ä¸ªåŠä»¥ä¸Šçš„ææ¡ˆï¼Œå› ä¸ºæŒ‰ç…§çº¦æŸP1ï¼Œ
è¿™äº›ææ¡ˆå¯èƒ½æ˜¯å…¶ä»–èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªææ¡ˆï¼Œå·²ç»è¢«æ¥å—äº†ã€‚

ä¸ºäº†åŒºåˆ†ææ¡ˆï¼Œéœ€è¦ä¸ºææ¡ˆåˆ†é…ç¼–å·ï¼Œæ¯”å¦‚å‘èµ·èŠ‚ç‚¹çš„æœ¬åœ°åºåˆ—å·+ipåœ°å€ã€‚**è¿™é‡Œä¸è¦æ··æ·†ææ¡ˆçš„ç¼–å·å’Œå¤åˆ¶çŠ¶æ€æœºè¾“å…¥çš„ç¼–å·ï¼Œ
çŠ¶æ€æœºæ¯ä¸ªç¼–å·ï¼ˆä¾æ¬¡é€’å¢ï¼‰çš„è¾“å…¥å†…å®¹å¯¹åº”ä¸€æ¬¡å…±è¯†è¿‡ç¨‹ï¼Œè¯¥å…±è¯†è¿‡ç¨‹å¯èƒ½å­˜åœ¨å¤šä¸ªç¼–å·ï¼ˆåªéœ€ä¿è¯å•è°ƒï¼‰çš„ææ¡ˆ**ã€‚

æ—¢ç„¶æ¥æ”¶è€…éœ€æ¥æ”¶å¤šä¸ªææ¡ˆï¼Œè¿™å°±å¼•å‡º**çº¦æŸP2**ï¼š

>P2ï¼šä¸€æ—¦ä¸€ä¸ªå…·æœ‰ value v çš„ææ¡ˆè¢«æ‰¹å‡†ï¼ˆchosenï¼‰ï¼Œé‚£ä¹ˆè¢«æ‰¹å‡†ï¼ˆchosenï¼‰çš„æ›´é«˜ç¼–å·çš„ææ¡ˆå¿…é¡»å…·æœ‰ value vã€‚

ææ¡ˆè¢«æ‰¹å‡†ï¼Œè¡¨ç¤ºè‡³å°‘è¢«ä¸€ä¸ªæ¥æ”¶è€…æ¥å—è¿‡ã€‚æ‰€ä»¥åŠ å¼ºP2ï¼Œå¾—åˆ°çº¦æŸ**P2a**ï¼š

>ä¸€æ—¦æŸä¸ªææ¡ˆå€¼vè·å¾—æ‰¹å‡†ï¼Œä»»ä½•æ¥æ”¶è€…æ¥æ”¶çš„æ›´é«˜ç¼–å·çš„ææ¡ˆå€¼ä¹Ÿæ˜¯vã€‚
    
å› ä¸ºé€šä¿¡æ˜¯å¼‚æ­¥çš„ï¼Œä¸€ä¸ªä»ä¼‘çœ æˆ–æ•…éšœæ¢å¤çš„èŠ‚ç‚¹ï¼Œç»™æŸä¸ªå°šæœªæ”¶åˆ°ä»»ä½•ææ¡ˆçš„èŠ‚ç‚¹ï¼Œæäº¤ä¸€ä¸ªæ›´é«˜ç¼–å·çš„ä¸åŒææ¡ˆv1ï¼ŒæŒ‰ç…§çº¦æŸP1ï¼Œè¯¥èŠ‚ç‚¹å¿…é¡»æ¥æ”¶è¯¥ææ¡ˆï¼Œ
è¿™å°±è¿èƒŒäº†çº¦æŸP2aï¼Œæ‰€ä»¥ï¼Œä¸å…¶çº¦æŸæ¥æ”¶è€…ï¼Œçº¦æŸæäº¤è€…æ›´åŠ æ–¹ä¾¿ï¼Œå¯¹P2aåŠ å¼ºçº¦æŸï¼Œå¾—åˆ°çº¦æŸ**P2b**ï¼š

>ä¸€æ—¦æŸä¸ªææ¡ˆå€¼vè·å¾—æ‰¹å‡†ï¼Œä»»ä½•å‘èµ·è€…å‘èµ·çš„æ›´é«˜ç¼–å·çš„ææ¡ˆå€¼å¿…é¡»æ˜¯vã€‚

æˆ‘ä»¬æ¥è¯æ˜P2bå¦‚ä½•ä¿è¯P2ã€‚

ä½¿ç”¨å½’çº³æ³•ï¼Œå‡è®¾ç¼–å·ä¸ºmï¼ˆm < nï¼‰çš„ææ¡ˆè¢«é€‰ä¸­ï¼Œä¸”måˆ°n-1çš„ææ¡ˆå€¼éƒ½ä¸ºvï¼Œé‚£ä¹ˆå­˜åœ¨ä¸€ä¸ªå¤§å¤šæ•°æ¥æ”¶è€…çš„é›†åˆCæ¥æ”¶äº†mææ¡ˆï¼Œè¿™æ„å‘³ç€ï¼š

>Cä¸­æ¯ä¸ªæ¥æ”¶è€…éƒ½æ‰¹å‡†äº†måˆ°n-1å…¶ä¸­ä¸€ä¸ªææ¡ˆï¼Œmåˆ°n-1çš„æ¯ä¸ªè¢«æ‰¹å‡†çš„ææ¡ˆå…¶å€¼éƒ½æ˜¯vã€‚

å› ä¸ºä»»ä½•å¤§å¤šæ•°æ¥æ”¶è€…é›†åˆSï¼Œå’ŒCè‡³å°‘æœ‰ä¸€ä¸ªå…¬å…±æ¥æ”¶è€…ï¼Œç¼–å·ä¸ºnçš„ææ¡ˆwè¢«æ‰¹å‡†ï¼Œé‚£ä¹ˆåªæœ‰ä¸¤ç§æƒ…å†µï¼š

>1. å­˜åœ¨ä¸€ä¸ªåŒ…å«å¤§å¤šæ•°æ¥æ”¶è€…çš„é›†åˆSï¼Œä»æœªæ¥å—è¿‡å°äºnçš„ææ¡ˆã€‚
>2. wå’ŒSä¸­æ‰€æœ‰å·²æ¥å—çš„ã€ç¼–å·å°äºnçš„æœ€å¤§ç¼–å·ææ¡ˆå€¼ç›¸åŒï¼Œå³å€¼ä¸ºvã€‚å› ä¸ºå…¬å…±æ¥æ”¶è€…éœ€è¦æ‰¹å‡†ç›¸åŒçš„ææ¡ˆå€¼ã€‚

è¿™ä¸ªè¯æ˜çœ‹èµ·æ¥å¾ˆå¤šä½™ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œç¼–å·måˆ°nçš„ææ¡ˆä¸æ˜¯æŒ‰ç¼–å·å…ˆåé¡ºåºå‘èµ·çš„ï¼Œè¿™äº›ææ¡ˆçš„å‘èµ·é¡ºåºæ˜¯æ²¡æœ‰ä¿è¯çš„ã€‚

ç¼–å·ä¸ºnææ¡ˆçš„å‘èµ·è€…éœ€è¦çŸ¥é“æ‰€æœ‰å·²æ¥å—ææ¡ˆä¸­å°äºnçš„æœ€å¤§ç¼–å·ææ¡ˆçš„å€¼ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚çŸ¥é“å·²æ¥å—çš„ææ¡ˆæ˜¯å€¼å¾ˆç®€å•çš„ï¼Œé¢„æµ‹æœªæ¥å¾ˆéš¾åŠï¼Œ
æ¯”å¦‚ï¼šç¼–å·ä¸ºnçš„ææ¡ˆå€¼ï¼Œå¦‚ä½•çŸ¥é“å°šæœªæ”¶åˆ°çš„n-1ç¼–å·ææ¡ˆçš„å€¼å‘¢ã€‚

ä¸å…¶é¢„æµ‹æœªæ¥ï¼Œä¸å¦‚è®©æ¥å—è€…åœ¨ä¹‹åæ‹’ç»æ‰€æœ‰å°äºnçš„ææ¡ˆã€‚

ç”±æ­¤å¼ºåŒ–çº¦æŸP1ï¼Œå¾—åˆ°**P1a**:
    
>æ¥æ”¶è€…æ‹’ç»æ¥å—ç¼–å·æ¯”å½“å‰å·²çŸ¥æœ€å¤§ç¼–å·næ›´å°çš„ææ¡ˆã€‚

å¾—åˆ°paxosç®—æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. prepareé˜¶æ®µï¼š
    1. å‘èµ·è€…é€‰æ‹©ä¸€ä¸ªææ¡ˆç¼–å·nå¹¶å°†prepareè¯·æ±‚å‘é€ç»™æ¥æ”¶è€…ä¸­çš„ä¸€ä¸ªå¤šæ•°æ´¾ï¼›
    2. æ¥æ”¶è€…æ”¶åˆ°prepareæ¶ˆæ¯åï¼Œå¦‚æœææ¡ˆçš„ç¼–å·å¤§äºå®ƒå·²ç»å›å¤çš„æ‰€æœ‰prepareæ¶ˆæ¯(å›å¤æ¶ˆæ¯è¡¨ç¤ºæ¥å—accept)ï¼Œ
åˆ™æ¥æ”¶è€…å°†è‡ªå·±ä¸Šæ¬¡æ¥å—çš„ææ¡ˆå›å¤ç»™å‘èµ·è€…ï¼Œå¹¶æ‰¿è¯ºä¸å†å›å¤å°äºnçš„ææ¡ˆï¼›å¦‚æœæ²¡æœ‰å›å¤è¿‡prepareæ¶ˆæ¯ï¼Œä¹Ÿæ‰¿è¯ºä¸å†å›å¤å°äºnçš„ææ¡ˆã€‚
2. accepté˜¶æ®µï¼š
    1. å½“ä¸€ä¸ªå‘èµ·è€…æ”¶åˆ°äº†å¤šæ•°æ¥æ”¶è€…å¯¹prepareçš„å›å¤åï¼Œå°±è¿›å…¥æ‰¹å‡†é˜¶æ®µã€‚
 å®ƒè¦å‘å›å¤prepareè¯·æ±‚çš„æ¥æ”¶è€…å‘é€acceptè¯·æ±‚ï¼ŒåŒ…æ‹¬ç¼–å·nå’Œprepareé˜¶æ®µè¿”å›çš„å°äºnçš„æœ€å¤§ææ¡ˆçš„å€¼ã€‚
    2. å¦‚æœacceptçš„ææ¡ˆç¼–å·nå¤§äºç­‰äºæ¥æ”¶è€…å·²æ‰¿è¯ºçš„ç¼–å·å€¼ï¼Œæ¥æ”¶è€…å°±æ‰¹å‡†è¿™ä¸ªè¯·æ±‚ã€‚
    3. acceptè¢«å¤šæ•°æ´¾æ‰¹å‡†åï¼Œå‘èµ·è€…å†é€šçŸ¥æ‰€æœ‰æ¥æ”¶è€…ææ¡ˆå·²æ‰¹å‡†ï¼ˆdecided)çš„æ¶ˆæ¯ã€‚

æˆ‘ä»¬å¯¹æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ä¸æ–­ä½¿ç”¨ä»¥ä¸Šç®—æ³•ï¼Œå³å¯å¯¹æ¯ä¸ªç¼–å·çš„æ“ä½œå†…å®¹è¾¾æˆå…±è¯†ã€‚è¿™å½“ç„¶ä¼šå¯¼è‡´æŸäº›å®¢æˆ·æäº¤çš„è¯·æ±‚å¤±è´¥ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å®¢æˆ·ç«¯é‡è¯•è§£å†³ã€‚

Paxosè¿˜å­˜åœ¨ä¸€äº›ä¼˜åŒ–æŠ€å·§ï¼Œå‡å°‘é€šä¿¡æ¬¡æ•°ï¼Œè¿™é‡Œä¸å®ç°ï¼Œå…·ä½“å¯å‚è€ƒç›¸å…³èµ„æ–™ã€‚

## é”®å€¼æœåŠ¡çš„ä»£ç å®ç°
æä¾›æœåŠ¡çš„ç¬¬ä¸€æ­¥æ˜¯æ¥å—ã€è§£æå®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œå‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œä½¿ç”¨JAVA NIOå¤„ç†ã€‚

### JAVA NIOçš„ä½¿ç”¨
é¦–å…ˆæ‰“å¼€socketæ¥æ”¶å®¢æˆ·è¿æ¥ï¼Œåœ¨è¿æ¥æˆåŠŸçš„channelä¸ŠæŒ‚è½½ä¸€ä¸ª[RespReadHandler](https://z42y.github.io/parliament/javadoc//io/github/parliament/resp/RespReadHandler.html)ç±»ï¼Œ
ä½¿ç”¨[RespDecoder](https://z42y.github.io/parliament/javadoc//io/github/parliament/resp/RespDecoder.html)ç±»å¯¹å¼‚æ­¥åˆ°æ¥çš„å­—èŠ‚æŠ¥æ–‡è¿›è¡Œè§£ç ï¼ŒRespReadHandlerä½¿ç”¨å…¶getæ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è§£ç å®Œæˆã€‚

è§£ç å®Œæˆåï¼Œä½¿ç”¨[KeyValueEngine](https://z42y.github.io/parliament/javadoc//io/github/parliament/kv/KeyValueEngine.html)è¿›è¡ŒçœŸæ­£çš„é”®å€¼è¯»å†™å¤„ç†ï¼Œæ­¤å¤„å…ˆä¸è€ƒè™‘KeyvalueEngineçš„å®ç°ç»†èŠ‚ã€‚

æ‰§è¡Œå®Œå®¢æˆ·ç«¯å‘½ä»¤åï¼ŒReadHandleræ–°å»ºä¸€ä¸ª[RespWriteHandler](https://z42y.github.io/parliament/javadoc//io/github/parliament/resp/RespWriteHandler.html)å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œ
æ¥ç€é‡æ–°æŒ‚è½½ä¸€ä¸ªRespReadHandlerè¿›è¡Œä¸‹ä¸€ä¸ªè¯·æ±‚å¤„ç†ã€‚

é‡æ–°ç”ŸæˆRespWriterHandlerå’ŒRespReadHandleræ˜¯ä¸ºäº†æ–¹ä¾¿è¿›è¡ŒGCï¼Œå½“ç„¶å¯ä»¥æ‰‹å·¥ç®¡ç†å„ç§bufferçš„å›æ”¶å’Œé‡åˆ©ç”¨ï¼Œè¿™é‡Œä¸åšè¯¦ç»†è®¾è®¡äº†ã€‚

å› ä¸ºä¿å­˜çš„å¯¹è±¡éƒ½æ¯”è¾ƒå°ï¼Œ[KeyValueEngine](https://z42y.github.io/parliament/javadoc/io/github/parliament/kv/KeyValueEngine.html)å¹¶æ²¡æœ‰ä½¿ç”¨InputStreamä¹‹ç±»çš„æ¨¡å¼è¿›ä¸€æ­¥æå‡å¼‚æ­¥æ€§èƒ½ã€‚

### ç½‘ç»œåè®®çš„è§£ææ„é€ 
[RespDecoder](https://z42y.github.io/parliament/javadoc/io/github/parliament/resp/RespDecoder.html)æ˜¯redisçš„[RESPåè®®](https://redis.io/topics/protocol)è§£ç å™¨ï¼Œ
RESPä¸€å…±æœ‰ä»¥ä¸‹å‡ ç§æ•°æ®ç±»å‹ï¼š

- SIMPLE_STRING å­—ç¬¦ä¸²
- ERROR é”™è¯¯å­—ç¬¦ä¸²
- INTEGER æ•´æ•°
- BULK_STRING äºŒè¿›åˆ¶å­—èŠ‚ç»„
- ARRAY æ•°ç»„

é™¤äº†ARRAYå¯ä»¥åŒ…å«å…¶ä»–ç±»å‹å’Œå…¶ä»–ARRAYï¼Œå¤„ç†ç¨ç¨éº»çƒ¦å¤–ï¼Œå…¶ä»–ç±»å‹éƒ½å®¹æ˜“è§£æã€‚

ä½¿ç”¨JAVAæ ‡å‡†åº“ä¸­ByteBufferç±»ç›´æ¥è§£æåè®®æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œå› ä¸ºæŠ¥æ–‡çš„å†™å…¥å’Œè¯»å–æ˜¯å¹¶å‘çš„ï¼Œä¸å¯èƒ½ç­‰åˆ°æŠ¥æ–‡è¯»å–å®Œæˆåï¼Œæ‰å¼€å§‹è§£æï¼Œ
ç”šè‡³æ— æ³•çŸ¥é“æŠ¥æ–‡ä»€ä¹ˆæ—¶å€™ç»“æŸã€‚

å¦å¤–ï¼ŒæŠ¥æ–‡å¤„ç†å¾€å¾€éœ€è¦"å›æº¯"æ“ä½œï¼Œä»ä¹‹å‰æŸä¸ªä½ç½®é‡æ–°å¼€å§‹è§£æã€‚ä½¿ç”¨ByteBufferçš„flipå’Œrewindã€resetå¤ªåº•å±‚ï¼ŒæŠ½è±¡å±‚æ¬¡ä¸å¤Ÿã€‚

æ‰€ä»¥é€šè¿‡å®ç°è‡ªå·±çš„[ByteBuf](https://z42y.github.io/parliament/javadoc/io/github/parliament/resp/ByteBuf.html)è¿›è¡ŒæŠ¥æ–‡è§£æï¼Œä¸»è¦æä¾›äº†ç‹¬ç«‹çš„è¯»å†™indexï¼Œæ–¹ä¾¿å›æº¯å’Œè¯»å†™æ“ä½œåˆ†ç¦»ã€‚
åº•å±‚ä½¿ç”¨byte[]ä¿å­˜æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨direct allocateçš„ByteBufferæå‡æ€§èƒ½ï¼Œä½†æ˜¯ByteBufçš„ç”Ÿå‘½å‘¨æœŸçŸ­ã€æ•°æ®é‡éƒ½å°ï¼Œæ— æ³•ä½“ç°å…¶ä¼˜åŠ¿ã€‚

## é”®å€¼å‘½ä»¤å®ç°
æ”¶åˆ°è¯·æ±‚åï¼Œéœ€è¦æ‰§è¡ŒGETå’ŒPUTã€DELã€RANGEæ“ä½œï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯å…¸å‹çš„æœ‰åºMapæ–¹æ³•ï¼Œæ¯”å¦‚JDKä¸­çš„[NavigableMapæ¥å£](https://docs.oracle.com/javase/9/docs/api/java/util/NavigableMap.html)ï¼Œ
å…¶å¹¶å‘å®ç°[ConcurrentSkipListMap](https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/ConcurrentSkipListMap.html)é‡‡ç”¨äº†skip listç®—æ³•ï¼Œ
æœ¬åº”ç”¨ä¹Ÿé‡‡ç”¨è¯¥ç®—æ³•ã€‚

skip listï¼ˆè·³è¡¨ï¼‰å¹³å‡æŸ¥æ‰¾å’Œæ’å…¥æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(log n)ï¼Œç®—æ³•è¯´æ˜è§[wikipedia](https://zh.wikipedia.org/wiki/%E8%B7%B3%E8%B7%83%E5%88%97%E8%A1%A8)ã€‚
è¯¥ç®—æ³•é€šè¿‡ç»´æŠ¤å¤šå±‚é“¾è¡¨ï¼Œä¾æ¬¡å¿«é€Ÿæ¥è¿‘æŸ¥æ‰¾ç›®æ ‡ã€‚

æ¼”ç¤ºï¼ˆæ¥è‡ªWikipediaï¼‰ï¼š

![skip listç¤ºä¾‹](./skiplist.gif)

### skip listçš„æŒä¹…åŒ–å®ç°
åœ¨å†…å­˜ä¸­å®ç°skip listçš„æ•°æ®ç»“æ„éå¸¸ç®€å•ï¼Œä½¿ç”¨æ–‡ä»¶æ¥å£çš„æŒä¹…åŒ–å®ç°åˆ™éœ€è¦è€ƒè™‘å¾ˆå¤šç»†èŠ‚ï¼Œè¿™é‡Œçš„å®ç°ä¸è€ƒè™‘å¹¶å‘ã€‚

é¦–å…ˆéœ€è¦è€ƒè™‘å¦‚ä½•ä½¿ç”¨æ–‡ä»¶è¡¨ç¤ºé“¾è¡¨ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éœ€è¦çŸ¥é“ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä½ç½®ï¼Œ
å¯¹äºå†…å­˜å®ç°çš„skip listï¼Œç¼–ç¨‹è¯­è¨€çš„æŒ‡é’ˆæˆ–å¼•ç”¨å¤„ç†èµ·æ¥éå¸¸è‡ªç„¶ï¼Œä½¿ç”¨æ–‡ä»¶å®ç°ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹å·¥åˆ†é…å’Œç®¡ç†èŠ‚ç‚¹åœ¨æ–‡ä»¶ä¸­çš„åœ°å€å’Œå­˜å‚¨ã€‚

ä»¥skip listçš„æ’å…¥æ“ä½œä¸ºä¾‹ï¼Œä¸€ç§ç®€è¦çš„æ­¥éª¤å¦‚ä¸‹ï¼š

- è·å¾—æœ€ä¸Šå±‚é“¾è¡¨çš„å¤´èŠ‚ç‚¹çš„æ–‡ä»¶åç§°å’Œä½ç½®ä¿¡æ¯ï¼Œæ–‡ä»¶åå’Œä½ç½®ä¿¡æ¯å¯ä»¥è®°å½•åœ¨å…¶ä»–å…ƒä¿¡æ¯æ–‡ä»¶ä¸­ã€‚
- è·å¾—å¤´èŠ‚ç‚¹çš„keyå€¼ï¼Œä¸å‚æ•°keyæ¯”è¾ƒï¼Œä»¥å†³å®šç»§ç»­æŸ¥æ‰¾åŒå±‚ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è¿˜æ˜¯è¿›å…¥ä¸‹ä¸€å±‚é“¾è¡¨ã€‚
    - èŠ‚ç‚¹ä¸­keyçš„é•¿åº¦ä¸æ˜¯å›ºå®šçš„ï¼Œæ–‡ä»¶ä¸­éœ€è¦åŒºåˆ†keyå€¼ã€åœ°å€å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨æŸå›ºå®šå­—æ®µä¿å­˜keyé•¿åº¦ï¼Œä»¥ä¾¿ç¨‹åºå¿«é€Ÿå®šä½ã€‚
- åˆ°è¾¾åº•å±‚èŠ‚ç‚¹åï¼Œå¯»æ‰¾æ’å…¥ä½ç½®ã€‚
    - åº•å±‚èŠ‚ç‚¹éœ€è¦ä¿å­˜keyå¯¹åº”çš„valueå€¼ï¼Œå¯ä»¥ä¿å­˜åœ¨èŠ‚ç‚¹ä¸­ï¼ˆåŒæ ·éœ€è¦ä½¿ç”¨æŸä¸ªå›ºå®šå­—æ®µä¿å­˜valueé•¿åº¦ï¼‰ï¼Œä¹Ÿå¯ä»¥ä¿å­˜åœ¨å…¶ä»–åœ°æ–¹ï¼Œä½¿ç”¨åœ°å€è¿›è¡ŒæŸ¥æ‰¾ï¼Œä½†è¿™æ ·ä¼šå¤šä¸€æ¬¡ç£ç›˜å¯»å€æ“ä½œã€‚
    - å¾…æ’å…¥ä½ç½®å¯èƒ½åœ¨é“¾è¡¨ä¸­é—´ï¼Œæ–‡ä»¶æ¥å£æ²¡æœ‰insertä¹‹ç±»çš„æ“ä½œï¼Œä¸ºäº†åç»­èŠ‚ç‚¹ä¸è¢«è¦†ç›–ï¼Œéœ€ä¾æ¬¡æ‹·è´åç»­èŠ‚ç‚¹åˆ°æ–‡ä»¶ä¸­çš„æ–°ä½ç½®ã€‚
    - æ›´æ”¹èŠ‚ç‚¹ä½ç½®åï¼Œéœ€è¦æ›´æ–°ç›¸å…³èŠ‚ç‚¹ä¿å­˜çš„è¯¥èŠ‚ç‚¹çš„ä½ç½®ä¿¡æ¯ã€‚
    
å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‰ç…§æ–‡ä»¶ç‰©ç†ä½ç½®è¿›è¡Œåœ°å€ç®¡ç†ï¼Œç»´æŠ¤ä½ç½®ä¿¡æ¯éå¸¸éº»çƒ¦ï¼Œæˆ‘ä»¬å¸Œæœ›æ–°èŠ‚ç‚¹çš„åˆ†é…ä¸ä¼šæ”¹å˜åŸæœ‰èŠ‚ç‚¹çš„ç‰©ç†ä½ç½®ï¼Œ
åŒæ—¶å¸Œæœ›å³ä¾¿æ›´æ–°äº†ç›¸å…³èŠ‚ç‚¹çš„ç‰©ç†ä½ç½®åï¼Œä¸ç”¨æ›´æ”¹å…¶ä»–èŠ‚ç‚¹å¯¹è¯¥èŠ‚ç‚¹çš„å¼•ç”¨ã€‚

å‚è€ƒå†…å­˜ç®¡ç†ä¸­ä¸åŒè¿›ç¨‹å…±äº«ç›¸åŒåœ°å€ç©ºé—´çš„æ–¹å¼ï¼Œé‡‡ç”¨ä¸€ä¸ªæ˜ å°„è¡¨ï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªå”¯ä¸€ç¼–å·è¡¨ç¤ºè™šæ‹Ÿåœ°å€ï¼Œåœ¨æ˜ å°„è¡¨ä¸­ä¿å­˜è¯¥è™šæ‹Ÿåœ°å€çš„æ–‡ä»¶ç‰©ç†ä½ç½®ã€‚
è¿™æ ·ï¼Œåœ¨æ–‡ä»¶ä¸­ç§»åŠ¨èŠ‚ç‚¹åï¼Œåªéœ€æ›´æ–°æ˜ å°„è¡¨ä¸­è¯¥èŠ‚ç‚¹çš„æ˜ å°„ä¿¡æ¯ã€‚åˆ†é…æ–°ç©ºé—´æ—¶ï¼Œä¹Ÿä¸ç”¨æŒ‰ç…§é€»è¾‘ä½ç½®å†³å®šç‰©ç†ç©ºé—´çš„ä½ç½®ã€‚

è§£å†³äº†åœ°å€é—®é¢˜ï¼Œè¯¥æ–¹æ¡ˆå¦ä¸€ä¸ªé—®é¢˜æ˜¯æ•ˆç‡ä½ä¸‹ï¼Œæ— è®ºæŸ¥æ‰¾å’Œæ›´æ–°ï¼Œéƒ½éœ€è¦è¯»å–å¾ˆå¤šæ¬¡ç£ç›˜ï¼Œç£ç›˜çš„è¯»å†™æ—¶é—´æ¯”å†…å­˜è¯»å†™æ—¶é—´é«˜ä¸‰ä¸ªæ•°é‡çº§ã€‚

æ¯ä¸ªnodeå¯¹åº”ä¸€ä¸ªåœ°å€ï¼Œç©ºé—´ä¸Šä¸å¤ªç»æµï¼Œ1ä¸‡ä¸ªèŠ‚ç‚¹è‡³å°‘éœ€è¦8ä¸‡ä¸ªå­—èŠ‚çš„æ˜ å°„ç©ºé—´ï¼ˆç¼–å·+åœ°å€ï¼‰ã€‚

å¦å¤–ï¼Œå¤§éƒ¨åˆ†å­˜å‚¨è®¾å¤‡æ˜¯ä»¥"å—"ï¼ˆblockï¼‰ä¸ºè¯»å†™å•ä½çš„ï¼Œå—çš„å¤§å°å¸¸è§æœ‰4K bytesã€8K bytesç­‰ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸€èˆ¬ä»¥è®¾å¤‡çš„å—å¤§å°çš„æ•´æ•°å€ä¸ºè¯»å†™å•ä½ã€‚
å•ä¸ªnodeçš„æ–‡ä»¶è¯»å†™æ— æ³•å‘æŒ¥å—è®¾å¤‡çš„æ€§èƒ½ä¼˜åŠ¿ã€‚

åŒæ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿå¯¹å•ä¸ªæ–‡ä»¶çš„å¤§å°ä¹Ÿæœ‰é™åˆ¶ã€‚

### Pageç®¡ç†
ç»“åˆä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬æŒ‰æ–‡ä»¶ç³»ç»Ÿçš„å—å¤§å°ä¸ºå•ä½åˆ†é…æ–‡ä»¶ç©ºé—´ï¼Œä¸€ä¸ªå—å¤§å°çš„ç©ºé—´ç§°ä¸ºpageï¼Œæ¯ä¸ªpageæœ‰ä¸€ä¸ªå”¯ä¸€ç¼–å·ï¼Œä½¿ç”¨heapï¼ˆå †æ–‡ä»¶ï¼‰ç®¡ç†pageï¼Œheapæ–‡ä»¶å¯èƒ½æœ‰å¤šä¸ªï¼Œ
åœ¨ä¸€ä¸ªpageä¸Šæ‰˜ç®¡å¤šä¸ªå®é™…çš„skip listèŠ‚ç‚¹ã€‚

æ¯ä¸ªheapæ–‡ä»¶çš„ç»“æ„å¦‚ä¸‹ï¼š
```
|------------------heads------------------------|---------pages-------|
| page number (4å­—èŠ‚) | page location (4å­—èŠ‚)|.. | page | page |...|...|
```

#### åˆå§‹åŒ–
ç¬¬ä¸€æ¬¡è¿è¡Œä¼šè¿è¡Œpagerçš„initæ–¹æ³•ï¼Œé€šè¿‡è¯¥æ–¹æ³•æŒ‡å®šheapå­˜å‚¨ç›®å½•ã€æ¯ä¸ªheapæ–‡ä»¶çš„æœ€å¤§å­—èŠ‚æ•°ã€æ¯ä¸ªpageçš„å­—èŠ‚æ•°è¿›è¡Œå­˜å‚¨ç›®å½•çš„åˆå§‹åŒ–ï¼Œ
åœ¨ç›®å½•ä¸­ä½¿ç”¨metainfä¿å­˜å­—èŠ‚æ•°ä¿¡æ¯ï¼Œä½¿ç”¨page_seqæ–‡ä»¶ä¿å­˜å½“å‰æœ€å¤§pageç¼–å·ï¼Œä»¥ä¾¿åœ¨è¿›ç¨‹é‡å¯æ—¶æ¢å¤pageç®¡ç†ã€‚

#### Pageå¯»å€åŠåˆ†é…
Pagerçš„allocateæ–¹æ³•é¦–å…ˆä½¿ç”¨ç©ºé—²pageçš„ç¼–å·ï¼ˆä»metainfå°¾éƒ¨è·å–ç©ºé—²pageç¼–å·ï¼‰ï¼Œæ²¡æœ‰ç©ºé—²pageåˆ™é€’å¢page_seqï¼Œè·å¾—ä¸€ä¸ªæ–°çš„pageç¼–å·ï¼Œ
é€šè¿‡pageç¼–å·æŸ¥æ‰¾åˆ°å¯¹åº”çš„heapæ–‡ä»¶ï¼Œå¦‚æœheapæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–ï¼Œä»heapæ–‡ä»¶æ„é€ ä¸€ä¸ªHeapå¯¹è±¡ã€‚

Heapå¯¹è±¡çš„å¤´éƒ¨headsæˆå‘˜å°†pageç¼–å·æ˜ å°„ä¸ºpageåœ¨è¯¥heapæ–‡ä»¶çš„åç§»åœ°å€ï¼Œå¦‚pageæœªåˆ†é…ï¼Œåˆ™åç§»ä¸º-1ã€‚

æ–°å»ºpageä»heapå°¾éƒ¨åˆ†é…ï¼Œåˆ†é…åæ›´æ–°headä¿¡æ¯å¹¶æŒä¹…åŒ–åˆ°heapæ–‡ä»¶ã€‚

### SkipListçš„æŸ¥æ‰¾
ä¸€ä¸ªpageä¸­åŒ…å«å¤šä¸ªskip listèŠ‚ç‚¹ï¼Œä¸ºäº†æé«˜è¯»å†™é€Ÿåº¦ï¼Œä¸€èˆ¬å°†pageç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œæ›´æ–°åï¼Œå†™å›æ–‡ä»¶ï¼Œè¿™é‡Œä½¿ç”¨weak referenceçš„cacheç¼“å­˜pageã€‚

skiplist.mfä¿å­˜äº†æ¯å±‚é¦–èŠ‚ç‚¹çš„ç¼–å·ï¼Œç”±SkipList.initæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚

pageè¢«åŠ è½½åˆ°å†…å­˜åï¼Œå„ä¸ªèŠ‚ç‚¹è½¬æ¢ä¸ºJDK NavigableMapåŒ…å«çš„æ¡ç›®ï¼Œä»¥ä¾¿pageä¸­å¿«é€ŸæŸ¥æ‰¾å®šä½ã€‚
skip listçš„ä¸Šå±‚èŠ‚ç‚¹å’Œåº•å±‚èŠ‚ç‚¹çš„å€¼å«ä¹‰ä¸åŒï¼Œä¸Šå±‚èŠ‚ç‚¹çš„valueè¡¨ç¤ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ‰€åœ¨pageçš„ç¼–å·ï¼Œåº•å±‚èŠ‚ç‚¹çš„valueè¡¨ç¤ºçœŸæ­£ä¿å­˜çš„å€¼ã€‚

ä¸ç®¡æŸ¥è¯¢è¿˜æ˜¯å†™å…¥ã€åˆ é™¤ï¼Œéƒ½éœ€è¦å…ˆå®šä½èŠ‚ç‚¹æ‰€åœ¨pageé¡µé¢ï¼Œå¦‚æŸ¥æ‰¾æŸkeyåœ¨æŸå±‚çº§çš„pageï¼Œä»£ç å¦‚ä¸‹ï¼š
```{.java}
private SkipListPage findSkipListPageForKey(byte[] key, int lv) throws IOException, ExecutionException {
    Preconditions.checkArgument(lv >= 0);
    Preconditions.checkArgument(lv < SkipList.this.height);
    int cursor = height - 1;
    SkipListPage start = null;
    SkipListPage up = null;
    while (cursor >= lv) {
        up = start;
        if (start == null) {
            start = skipListPages.get(startPages[cursor]);
        }
        SkipListPage slice = floorPage(start, key);

        if (cursor == lv) {
            return slice == null ? start : slice;
        }
        if (slice != null) {
            Map.Entry<byte[], byte[]> e = slice.map.floorEntry(key);
            int pn = ByteBuffer.wrap(e.getValue()).getInt();
            start = skipListPages.get(pn);
            start.setSuperPage(up);
        } else {
            start = null;
        }

        cursor--;
    }

    return start;
}
```
è¿™ä¸ªæ–¹æ³•è¿˜è´Ÿè´£æ›´æ–°ç›¸å…³pageçš„ä¸Šä¸€å±‚pageä¿¡æ¯ã€‚

floorPageä»æŒ‡å®špageå¼€å§‹æŸ¥æ‰¾æ‹¥æœ‰æœ€åä¸€ä¸ªå°äºç­‰äºå¾…æŸ¥æ‰¾å€¼çš„keyæ‰€åœ¨çš„pageï¼Œå®ç°å¦‚ä¸‹ï¼š
```{.java}
private SkipListPage floorPage(SkipListPage start, byte[] key) throws ExecutionException {
    SkipListPage current = start;
    SkipListPage floor = null;
    while (current != null) {
        Map.Entry<byte[], byte[]> entry = current.map.floorEntry(key);
        if (entry != null) {
            // åªæ˜¯åœ¨æœ¬pageå‘ç°å°äºkeyçš„è®°å½•ï¼Œè¿˜éœ€æ£€æŸ¥ä¸‹ä¸€é¡µã€‚
            floor = current;
        }

        if (current.getRightPageNo() > 0) {
            int pn = current.getRightPageNo();
            current = skipListPages.get(pn);
        } else {
            current = null;
        }
    }
    return floor;
}
```
æ³¨æ„ï¼Œå¦‚æœåœ¨è¯¥pageå¯¹åº”mapæœªæ‰¾åˆ°å¤§äºæŸ¥æ‰¾å€¼çš„è®°å½•ï¼Œè¿˜éœ€è¦åˆ°ä¸‹ä¸€ä¸ªpageæŸ¥æ‰¾ã€‚

### SkipListçš„æ›´æ–°
æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹å‰ï¼Œå…ˆä½¿ç”¨ä»¥ä¸Šæ–¹æ³•æŸ¥æ‰¾ã€åŠ è½½å¾…æ’å…¥çš„pageï¼Œæ›´æ–°ç›¸å…³mapï¼Œå†ä½¿ç”¨SkipListPage.updateæ›´æ–°æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š
```{.java}
private void update() throws IOException, ExecutionException {
    int s = HEAD_SIZE_IN_PAGE;
    int k = 0;

    for (byte[] key : map.keySet()) {
        s += key.length;
        s += 4;
        s += map.get(key).length;
        if (isLeaf) {
            s += 4;
        }
        k++;
    }
    size = s;
    keys = k;
    if (keys == 0) {
        pager.recycle(page);
    }

    if (remaining() < 0) {
        split();
    } else {
        sync();
    }
}
```

å¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœpageä¸åœ¨åŒ…å«æ•°æ®ï¼Œåˆ™å›æ”¶ï¼Œå¦‚æ•°æ®å·²è¶…è¿‡pageå¤§å°ï¼Œåˆ™åˆ†è£‚pageï¼Œåˆ†è£‚æ–¹æ³•ä¸ºåˆ†é…ä¸€ä¸ªpageï¼Œå¹¶å°†é™¤å¤´èŠ‚ç‚¹ä»¥å¤–çš„èŠ‚ç‚¹å­˜å‚¨åˆ°æ–°pageå³å¯ã€‚
```{.java}
private void split() throws IOException, ExecutionException {
    Preconditions.checkState(this.keys > 0);
    Preconditions.checkState(!map.isEmpty());
    Page p = SkipList.this.allocatePage(level);
    SkipListPage newPage = skipListPages.get(p.getNo());

    newPage.map = new ConcurrentSkipListMap<>(map.tailMap(map.firstKey(), false));
    Preconditions.checkState(!map.isEmpty());
    map = new ConcurrentSkipListMap<>(map.headMap(map.firstKey(), true));
    newPage.rightPageNo = this.rightPageNo;
    this.rightPageNo = newPage.getPage().getNo();

    this.update();
    newPage.update();

    Preconditions.checkState(pager.getPageSize() - this.getSize() >= 0);
    Preconditions.checkState(pager.getPageSize() - newPage.getSize() >= 0);
}
```

æ³¨æ„ï¼Œæ–‡ä»¶å†™å…¥ä¸æ˜¯åŸå­çš„ï¼Œå¯èƒ½åªå†™å…¥äº†éƒ¨åˆ†æ•°æ®ä¾¿å®•æœºäº†ï¼Œä¸å®Œæ•´çš„æ•°æ®ä¼šå¯¼è‡´è¿›ç¨‹æ— æ³•æ¢å¤åŸæœ‰çŠ¶æ€ï¼Œ
ï¼Œpersistence()éœ€è¦ä¿è¯è¦ä¹ˆå®Œå…¨å†™å…¥ï¼Œè¦ä¹ˆå®Œå…¨ä¸å†™ï¼Œ

AtomicFileWriterç±»å®ç°äº†åŸå­å†™å…¥ï¼Œå¹¶åœ¨è¿›ç¨‹å¯åŠ¨æ—¶è¿›è¡Œæ£€æŸ¥å’Œæ¢å¤ã€‚

 
## å®ç°å¤åˆ¶çŠ¶æ€æœº
[KeyValueEngine](https://z42y.github.io/parliament/javadoc/io/github/parliament/kv/KeyValueEngine.html)æ”¶åˆ°è¯·æ±‚ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œï¼Œ
è€Œæ˜¯äº¤ç»™[ReplicateStateMachine](https://z42y.github.io/parliament/javadoc/io/github/parliament/ReplicateStateMachine.html)ç”Ÿæˆä¸€ä¸ªæ–°çš„çŠ¶æ€æœºè¾“å…¥ï¼Œ
å¹¶å§”æ‰˜ReplicateStateMachineå¯¹è¯¥è¾“å…¥æ‰€åœ¨ç¼–å·çš„æ“ä½œè¾¾æˆå…±è¯†ï¼Œç”±ReplicateStateMachineå›è°ƒKeyValueEngineæ¥å£æ‰§è¡Œï¼Œè¿”å›ç»“æœã€‚

```{.java}
Input input = rsm.newState(bytes);
CompletableFuture<Output> future = rsm.submit(input);
return future.thenApply((output) -> {
    try {
        if (!Arrays.equals(input.getUuid(), output.getUuid())) {
            return RespError.withUTF8("å…±è¯†å†²çª");
        }
        return RespDecoder.create().decode(output.getContent()).get();
    } catch (Exception e) {
        logger.error("get submit result failed:", e);
        return RespError.withUTF8("get submit result failed:" + e.getClass().getName()
                + ",message:" + e.getMessage());
    }
});
```
å¦‚æœè¾¾æˆçš„å…±è¯†å†…å®¹ä¸æ˜¯æäº¤çš„å†…å®¹ï¼Œè¿”å›å®¢æˆ·ç«¯é”™è¯¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥å†³å®šé‡è¯•æˆ–æŠ¥é”™ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚éœ€è¦åˆ†é…ç‹¬ç«‹çš„idï¼Œä»¥åŒºåˆ†ç›¸åŒå†…å®¹çš„å®¢æˆ·è¯·æ±‚ï¼Œå‡å¦‚å®ç°å‘½ä»¤appendï¼Œä¸ºkeyå¯¹åº”çš„valueè¿½åŠ å†…å®¹ï¼Œä¸¤ä¸ªç›¸åŒçš„"append x y"è¯·æ±‚å¦‚ä¸åŠ idä¼šè¾¾æˆä¸€æ¬¡å…±è¯†ï¼Œä½†å®é™…åªæ‰§è¡Œäº†ä¸€æ¬¡ï¼Œ
valueåªè¿½åŠ äº†ä¸€ä¸ªyã€‚è¿™ä¸å®¢æˆ·é¢„æœŸä¸ä¸€è‡´ï¼Œå¯¼è‡´bugã€‚è§£å†³æ–¹æ³•æ˜¯ä¸ºå¾…å…±è¯†å†…å®¹å¢åŠ ä¸€ä¸ªuuidï¼š
```{.java}
public Input newState(byte[] content) throws DuplicateKeyException {
    return Input.builder().id(next()).uuid(uuid()).content(content).build();
}
```

ReplicateStateMachineå¯ä»¥å¹¶å‘è¿›è¡Œå¤šä¸ªPaxoså…±è¯†å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹é€’å¢åˆ†é…ä¸€ä¸ªç¼–å·ï¼Œæ‰€æœ‰RSMå®ä¾‹éƒ½æŒ‰ç…§ç¼–å·é¡ºåºï¼Œä½¿ç”¨åå°çº¿ç¨‹é¡ºåºæ‰§è¡Œæ‰€æœ‰ç¼–å·çš„å…±è¯†ç»“æœã€‚

é¡ºåºæ‰§è¡Œæ„å‘³ç€KeyValueEngineæ— æ³•å¹¶å‘å¤„ç†å·²å®Œæˆå…±è¯†çš„å„ä¸ªè¯·æ±‚ï¼Œå¦‚æœéœ€è¦æé«˜å¹¶å‘æ€§ï¼Œéœ€è¦ä¿è¯ä¸åŒæœºå™¨å¹¶å‘æ‰§è¡Œçš„ç»“æœä¸€æ ·ï¼Œè¿™æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œ
éœ€è¦å®Œå–„å„ç§é”æœºåˆ¶å’Œå¹¶å‘æ§åˆ¶ï¼Œè¿™é‡Œä¸åšå®ç°ã€‚

è¿›ç¨‹å¯èƒ½åœ¨KeyValueEngineæ‰§è¡Œæ•°æ®æ“ä½œå‘½ä»¤è¿‡ç¨‹ä¸­å¤±è´¥ï¼Œæˆ–è€…æ‰§è¡Œå®Œæˆï¼Œä½†åœ¨è¿”å›ReplicateStateMachineå‰å¤±è´¥ï¼ŒæœåŠ¡éœ€è¦åœ¨æ¢å¤æ—¶æ¢å¤ä¹‹å‰çš„æ­£ç¡®çŠ¶æ€ã€‚
æ•°æ®åº“ä¸€èˆ¬éœ€è¦é‡‡ç”¨[å†™å‰æ—¥å¿—](https://en.wikipedia.org/wiki/Write-ahead_logging)æŠ€æœ¯ä¿è¯äº‹åŠ¡å¯æ¢å¤ã€‚

æœ¬åº”ç”¨çš„PUTã€DELã€GETéƒ½æ˜¯å¹‚ç­‰çš„ï¼Œé‡å¤æ‰§è¡Œæ²¡æœ‰é—®é¢˜ï¼Œåªè¦ä¿è¯ä¸æ¼æ‰å‘½ä»¤å°±è¡Œï¼ŒReplicateStateMachineçš„æ‰§è¡Œæ—¥å¿—å¯ä»¥ä¿è¯è¿™ä¸€ç‚¹ï¼Œ
å…·ä½“å¯æŸ¥çœ‹[start](https://z42y.github.io/parliament/javadoc/io/github/parliament/ReplicateStateMachine.html#start(io.github.parliament.StateTransfer,java.util.concurrent.Executor))
å’Œ[apply](https://z42y.github.io/parliament/javadoc/io/github/parliament/ReplicateStateMachine.html#apply())æ–¹æ³•ã€[done](https://z42y.github.io/parliament/javadoc/io/github/parliament/ReplicateStateMachine.html#done(int))æ–¹æ³•ã€‚

ReplicateStateMachineå¹¶å‘æäº¤å…±è¯†è¯·æ±‚ç»™å…±è¯†æœåŠ¡[Coordinator](https://z42y.github.io/parliament/javadoc/io/github/parliament/Coordinator.html)ï¼Œ
Coordinatorå¯ä»¥ç”±å„ç§å…±è¯†ç®—æ³•å®ç°ã€‚

## å®ç°Paxoså…±è¯†ç®—æ³•
å®Œæˆä¸€æ¬¡å…±è¯†è¿‡ç¨‹çš„Paxos[ä¼ªä»£ç ](http://nil.csail.mit.edu/6.824/2015/notes/paxos-code.html)å¦‚ä¸‹ï¼š
```
--- Paxos Proposer ---
      	
     1	proposer(v):
     2    while not decided:
     2	    choose n, unique and higher than any n seen so far
     3	    send prepare(n) to all servers including self
     4	    if prepare_ok(n, na, va) from majority:
     5	      v' = va with highest na; choose own v otherwise   
     6	      send accept(n, v') to all
     7	      if accept_ok(n) from majority:
     8	        send decided(v') to all
      	
        
--- Paxos Acceptor ---

     9	acceptor state on each node (persistent):
    10	 np     --- highest prepare seen
    11	 na, va --- highest accept seen
      	
    12	acceptor's prepare(n) handler:
    13	 if n > np
    14	   np = n
    15	   reply prepare_ok(n, na, va)
    16   else
    17     reply prepare_reject
      	
      	
    18	acceptor's accept(n, v) handler:
    19	 if n >= np
    20	   np = n
    21	   na = n
    22	   va = v
    23	   reply accept_ok(n)
    24   else
    25     reply accept_reject
```

Paxosç®—æ³•æœ‰ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå¦‚multi-paxoså¯ä»¥å‡å°‘ä¸€æ¬¡è¯·æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨åŸå§‹ç®—æ³•ã€‚

[Paxosç±»](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/Paxos.html)ä½œä¸ºPaxosæœåŠ¡çš„é—¨é¢ç±»ï¼Œæä¾›å…±è¯†è¯·æ±‚ã€å…±è¯†ç»“æœæŸ¥è¯¢ç­‰åŠŸèƒ½å…¥å£ã€‚
ä»–ä¸ºæ¯ä¸ªå…±è¯†å®ä¾‹åˆ›å»ºç›¸åº”çš„å‘èµ·è€…ï¼ˆproposer)ï¼ŒåŒæ—¶ä¸ºæœ¬èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹çš„å‘èµ·è€…åˆ›å»ºã€ç®¡ç†å¯¹åº”çš„æ¥æ”¶è€…ï¼ˆacceptor)ã€‚

[Proposer](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/proposer/Proposer.html)ä¸ºå‘èµ·è€…å®ç°ï¼Œ
[LocalAcceptor](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/acceptor/LocalAcceptor.html)ä¸ºæ¥æ”¶è€…å®ç°ã€‚

å„ä¸ªå®ä¾‹çš„ææ¡ˆè¯·æ±‚å¯èƒ½æ¥è‡ªå…¶ä»–èŠ‚ç‚¹ï¼Œæ‰€ä»¥æä¾›ä¸€ä¸ªç½‘ç»œæœåŠ¡[PaxosServer](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/server/PaxosServer.html)ï¼Œ
é€šè¿‡å‚æ•°ä¸­çš„ç¼–å·åŒºåˆ†ä¸åŒå…±è¯†è¿‡ç¨‹å®ä¾‹ï¼Œè½¬å‘ç»™ä¸åŒå®ä¾‹çš„æœ¬åœ°æ¥æ”¶è€…å¤„ç†ï¼Œç„¶åè¿”å›å“åº”ã€‚

é…å¥—çš„ï¼Œæä¾›[SyncProxyAcceptor](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/client/SyncProxyAcceptor.html)ä½œä¸ºè¿œç«¯æ¥æ”¶è€…çš„æœ¬åœ°ç½‘ç»œä»£ç†ï¼Œ
è¯·æ±‚å„ä¸ªPaxosServerå®Œæˆææ¡ˆè¿‡ç¨‹ã€‚

[InetPeerAcceptors](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/client/InetPeerAcceptors.html)ä¸ºSyncProxyAceptorçš„åˆ›å»ºå·¥å‚ï¼Œ
ä½¿ç”¨ä¸€ä¸ªç®€å•çš„[è¿æ¥æ± ](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/client/ConnectionPool.html)ä¸ºSyncProxyAcceptoræä¾›nio channelå®ä¾‹ã€‚

æ¥å£å‚æ•°ä½¿ç”¨RESPåè®®ç¼–è§£ç ï¼ŒSyncProxyAcceptorä½¿ç”¨åŒæ­¥ç½‘ç»œAPIï¼Œç®€åŒ–ä½¿ç”¨é€»è¾‘ã€‚
å¦‚prepareæ–¹æ³•çš„ä»£ç†ï¼š
```{.java}
Prepare delegatePrepare(int round, String n) throws IOException {
    synchronized (channel) {
        ByteBuffer request = codec.encodePrepare(round, n);
        while (request.hasRemaining()) {
            channel.write(request);
        }

        return codec.decodePrepare(channel, n);
    }
}
```

### æ­£ç¡®æ€§ä¿è¯
ä¸Šé¢çš„ä¼ªä»£ç å¾ˆç®€å•ï¼Œä½†æ˜¯åœ¨è¿›ç¨‹å¯èƒ½å¼‚å¸¸é€€å‡ºçš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸å¤Ÿå®Œå¤‡çš„ã€‚è¿›ç¨‹è¢«æ€æ­»ã€æ–­ç”µéƒ½ä¼šå¯¼è‡´æ­£åœ¨å…±è¯†åå•†çš„è¿›ç¨‹é€€å‡ºï¼Œå¹¶åœ¨æ¢å¤åï¼Œå‡ºç°é”™è¯¯çš„ç»“æœã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¤šæ•°æ´¾ä¸ºæŸä¸ªç¼–å·çš„å…±è¯†å®ä¾‹é€šè¿‡äº†ä¸€ä¸ªææ¡ˆï¼Œä½†æ˜¯åœ¨decideé˜¶æ®µï¼Œå¤šæ•°æ´¾å…¨éƒ¨å¼‚å¸¸é€€å‡ºï¼Œåªæœ‰å¤šæ•°æ´¾ä»¥å¤–çš„èŠ‚ç‚¹å¤„ç†äº†ææ¡ˆç»“æœã€‚
ç¨åè¿™äº›å¤šæ•°æ´¾åˆæ¢å¤ï¼Œä¹‹å‰çš„ä¿¡æ¯å·²ç»ä¸¢å¤±ï¼Œæ­¤æ—¶åˆæ”¶åˆ°åŒä¸€ä¸ªå…±è¯†å®ä¾‹ç¼–å·çš„å¦ä¸€ä¸ªææ¡ˆï¼Œæ­¤ææ¡ˆè¢«é€šè¿‡ï¼Œå’Œæœªå¼‚å¸¸é€€å‡ºçš„èŠ‚ç‚¹æ¥å—çš„ææ¡ˆä¸ä¸€è‡´ã€‚

æ‰€ä»¥ï¼Œåœ¨prepareå’Œaccepté˜¶æ®µï¼Œéƒ½éœ€è¦æŒä¹…åŒ–Acceptorçš„çŠ¶æ€ï¼Œå®ä¾‹åŒ–Acceptoræ—¶ï¼Œå…ˆå°è¯•æ¢å¤å·²æŒä¹…åŒ–çš„çŠ¶æ€ã€‚
å¹¶é€šè¿‡å®šæœŸ[å­¦ä¹ ](https://z42y.github.io/parliament/javadoc/io/github/parliament/ReplicateStateMachine.html#catchUp())å…¶ä»–èŠ‚ç‚¹çš„å…±è¯†ç»“æœï¼Œå¿«é€Ÿèµ¶ä¸Šè¿›åº¦ã€‚

å¦‚[LocalAcceptor](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/acceptor/LocalAcceptor.html)çš„prepareï¼š
```{.java}
@Override
public synchronized Prepare prepare(String n) throws Exception {
    if (np == null || n.compareTo(np) > 0) {
        np = n;
        persistence(); // ä¿å­˜çŠ¶æ€
        return Prepare.ok(n, na, va);
    }
    return Prepare.reject(n);
}
```
[Paxosç±»](https://z42y.github.io/parliament/javadoc/io/github/parliament/paxos/Paxos.html)ä¿å­˜å’Œæ¢å¤acceptorçš„æ–¹æ³•åˆ†åˆ«å¦‚ä¸‹ï¼š
```{.java}
void persistenceAcceptor(int round, LocalAcceptor acceptor) throws IOException, ExecutionException {
    if (Strings.isNullOrEmpty(acceptor.getNp())) {
        return;
    }
    persistence.put((round + "np").getBytes(), acceptor.getNp().getBytes());
    if (!Strings.isNullOrEmpty(acceptor.getNa())) {
        persistence.put((round + "na").getBytes(), acceptor.getNa().getBytes());
    }
    if (acceptor.getVa() != null) {
        persistence.put((round + "va").getBytes(), acceptor.getVa());
    }
}

Optional<LocalAcceptor> regainAcceptor(int round) throws IOException, ExecutionException {
    byte[] np = persistence.get((round + "np").getBytes());

    if (np == null) {
        return Optional.empty();
    }
    byte[] na = persistence.get((round + "na").getBytes());
    byte[] va = persistence.get((round + "va").getBytes());

    String nps = new String(np);
    String nas = na == null ? null : new String(na);

    return Optional.of(new LocalAcceptorWithPersistence(round, nps, nas, va));
}
```

è¾“å…¥ä¸€ç›´åœ¨å¢é•¿ï¼Œéœ€è¦åˆ é™¤å…±è¯†æœåŠ¡ä¸­å·²ç»å¤„ç†å®Œæˆçš„è¾“å…¥ï¼Œè§[forgetæ–¹æ³•](https://z42y.github.io/parliament/javadoc/io/github/parliament/ReplicateStateMachine.html#forget())ã€‚

### æ´»è·ƒæ€§é—®é¢˜
æ ¹æ®[FLPä¸å¯èƒ½åŸç†](https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/)ï¼š

>ä»»ä½•åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œåªè¦æœ‰ä¸€ä¸ªè¿›ç¨‹å®•æœºï¼Œå‰©ä½™çš„è¿›ç¨‹å­˜åœ¨æ°¸è¿œæ— æ³•è¾¾æˆå…±è¯†çš„å¯èƒ½æ€§ã€‚

å¯¹äºPaxosç®—æ³•ï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°æ— æ³•è¾¾æˆå…±è¯†çš„æƒ…å†µï¼Œæ¯”å¦‚ä¸åŒproposerçš„acceptæ¯æ¬¡éƒ½å› å…¶ä»–proposeräº§ç”Ÿçš„æ›´é«˜prepareç¼–å·è€Œacceptorè¢«æ‹’ç»ã€‚
è§£å†³åŠæ³•æ˜¯åœ¨å¯èƒ½å†²çªæ—¶ï¼Œå¼•å…¥éšæœºç­‰å¾…ï¼Œé™ä½è¿™ç§å¯èƒ½æ€§ï¼Œå¹¶åœ¨é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°æ—¶ï¼Œå¤±è´¥é€€å‡ºã€‚å¦‚ï¼š
```{.java}
if (!decided) {
    retryCount++;
    try {
        Thread.sleep(Math.abs(random.nextInt()) % 300);
    } catch (InterruptedException e) {
        logger.error("Failed in propose.", e);
        return null;
    }
    if (retryCount >= 7) {
        logger.error("Failed in propose.Retried {} times.", 7);
        throw new IllegalStateException();
    }
}
```
å¦‚æœå»æ‰è¿™ä¸ªéšæœºç­‰å¾…ï¼Œåœ¨å¤šæ ¸æœºå™¨è¿è¡Œå•å…ƒæµ‹è¯•éå¸¸å®¹æ˜“å‡ºç°é‡è¯•å¤±è´¥ã€‚

## æ€»ç»“
åˆ°è¿™é‡Œï¼Œç³»ç»ŸåŸºæœ¬åŠŸèƒ½å°±å®Œæˆäº†ã€‚æˆ‘ä»¬çš„ç³»ç»Ÿå¾ˆç®€å•ï¼Œä½†æ˜¯ä½å¹¶å‘çš„åœºæ™¯ï¼Œä¹Ÿå¤Ÿç”¨äº†ã€‚

æˆ‘ä»¬åªä¿è¯äº†é«˜å¯ç”¨ï¼Œå¦‚æœè¦ä¿è¯å®¹é‡å’Œç³»ç»Ÿååé‡ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ‡åˆ†ï¼ˆshardingï¼‰ï¼Œä¸åŒæœºå™¨å¤„ç†ä¸åŒèŒƒå›´çš„æ•°æ®ï¼Œ
æ•°æ®èŒƒå›´çš„åˆ’åˆ†å¯ä»¥ä¼šéšç³»ç»Ÿå®¹é‡è€Œä¸æ–­å˜åŒ–ï¼Œè¿™æ„å‘³ç€æœ¬èº«åœ¨Aæœºå™¨çš„æ•°æ®ï¼Œå¯èƒ½éœ€è¦ç§»åŠ¨åˆ°Bæœºå™¨ä¸Šï¼Œè¯»è€…å¯ä»¥æ€è€ƒä¸€ä¸‹å¦‚ä½•åœ¨æ•°æ®åˆ‡åˆ†å˜åŒ–æ—¶ä¿è¯é¡ºåºä¸€è‡´æ€§ã€‚

æˆ‘ä»¬çš„SkipListæ²¡æœ‰å®ç°å¹¶å‘å¤„ç†ï¼Œä¸€ç§æ€è·¯æ˜¯å¯¹ä¸€å®šæ—¶é—´å†…å®Œæˆå…±è¯†çš„å¤šä¸ªè¯·æ±‚å¹¶å‘å¤„ç†ï¼Œè¯»è€…å¯ä»¥è¿›ä¸€æ­¥æ€è€ƒä¸åŒè¿›ç¨‹çš„å¹¶å‘å¤„ç†ç»“æœå¦‚ä½•ä¿è¯ä¸€è‡´ï¼Ÿ
